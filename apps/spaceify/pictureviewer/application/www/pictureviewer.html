<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<title>Bigscreen - Picture viewer</title>

	<link rel="stylesheet" href="pictureviewer.css">
	<script type="text/javascript" src="engine.io.js"></script>
	<script type="text/javascript" src="spaceifyclient.js"></script>
	<script type="text/javascript" src="pictureviewer_lang.js"></script>

	<script type="text/javascript">
		var self = this;
		var pictures = [];
		var picturesPos = -1;
		var pictureWidth = 0;
		var pictureHeight = 0;
		var pictureTimeoutId = null;
		var messageTimeoutId = null;
		//var isMaster = false;

		var MAX_PICTURES = 3;
		var FADEIN_TIME = 1200;
		var FADEOUT_TIME = 500;
		var MESSAGE_TIMEOUT = 5;
		var INFO_TIMEOUT = 5000;
		var RECONNECT_TIMEOUT = 10;
		var PICTURE_TIMEOUT = 5000;
		var NEW_PICTURE_TIMEOUT = 5000;

		// GET HOST FROM THE URL
		EDGE_HOSTNAME = window.location.hostname;
		document.domain = window.location.hostname;										// Same Origin Policy, bigscreen has the same domain

		/**
		 * DOM * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
		 */
		window.addEventListener("load", function()
			{
				if(typeof jQuery == "undefined")
				{
					var script = document.createElement("script");
					script.type = "text/javascript";
					script.onreadystatechange = function() { if(this.readyState == 4) pageLoaded(); }
					script.onload = function() { pageLoaded(); }
					script.src = location.protocol + "//" + EDGE_HOSTNAME + "/js/metro/jquery/jquery.min.js";

					var head = document.getElementsByTagName("head")[0] || document.documentElement;
					head.parentNode.insertBefore(script, head.nextSibling);
				}
				else
					pageLoaded();
			}, false);

		window.addEventListener("resize", resize, false);

		function resize()
		{
			var pict = $("#picture");
			if(!pict || pict.length == 0)
				return;

			var picturew = pictureWidth;
			var pictureh = pictureHeight;
			var screenw = $(window).width();
			var screenh = $(window).height();

			var wratio = 1.0;															// If the picture is wider and/or taller than the screen, use the smaller ratio to scale it.
			var hratio = 1.0;
			if(picturew > screenw)
				wratio = screenw / picturew;
			if(pictureh > screenh)
				hratio = screenh / pictureh;
			var ratio = Math.min(wratio, hratio);

			picturew = Math.round(picturew * ratio);
			pictureh = Math.round(pictureh * ratio);

			pict.width(picturew);
			pict.height(pictureh);
			pict.css("position", "absolute");
			pict.css("top", (Math.abs(screenh - pictureh) / 2) + "px");
			pict.css("left", (Math.abs(screenw - picturew) / 2) + "px");
		}

		function pageLoaded()
		{
			$("#picture").load(function()												// Bind event handler to the picture element
			{
				pictureWidth = $(this).width();
				pictureHeight = $(this).height();
				resize();

				$(this).fadeIn(FADEIN_TIME, function()
				{
					picturesPos++;
					pictureTimeoutId = setTimeout(loadPicture, PICTURE_TIMEOUT);
				});
			});

			window.parent.pageReady(true);
		}

		/**
		 * SHARED FUNCTIONS  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
		 * The bigscreen index.html (window.parent) calls these functions and they must be implemented.
		 */
		function setMaster(state)
		{ // Only one bigscreen and the content loaded to its iframe can be the master. Only the master should send messages to connected clients, e.g. video progress.
			//isMaster = state || isMaster;
		}

		function showContent(content/*e.g. picture url, video id, document url etc.*/, action/*e.g. show, play, stop, pause etc.*/)
		{
			/**
			 * Use this function to show picture/document, start/stop/pause video, etc.
			 * Bigscreen calls this function in two cases:
			 * 1. After bigscreen loads this to its iframe and this calls window.parent.pageReady
			 * 2. This is already loaded to bigscreens iframe
			 */
			showPicture(content);
		}

		/**
		 * COMMON FUNCTIONS  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
		 */
		function showPicture(url)
		{
			var uget = spaceifyNetwork.parseGET(url, true);								// parse GET and src url
			var a = $("<a>", { href: uget.origin } )[0];

			var pid = "";
			var purl = "";
			if(	a.hostname == "hs10.snstatic.fi" || a.hostname == "hs11.snstatic.fi" ||	// image from hs.fi
				a.hostname == "hs12.snstatic.fi" || a.hostname == "hs13.snstatic.fi")
			{
				var ps = a.pathname.split("/");
				pid = ps[ps.length - 1];
				purl = a.origin + "/webkuva/taysi/2000/" + pid;							// get the largets possible picture
			}
			else																		// image from some other source
				pid = purl = uget.origin;

			var ppos = -1;																// Is image already in the array
			for(p in pictures)
			{
				if(pictures[p].pid == pid)
				{ ppos = p; break; }
			}

			if(ppos == -1)																// Add only new pictures to the array
			{
				if(pictures.length == MAX_PICTURES)											// Max pictures -> remove first
					pictures.shift();
				pictures.push({pid: pid, url: purl});
				picturesPos = pictures.length - 1;
			}
			else																		// Show existing images
				picturesPos = ppos;

			loadPicture();

			return true;
		}

		function loadPicture()
		{
			if(pictureTimeoutId != null)
				window.clearTimeout(pictureTimeoutId);
			pictureTimeoutId = null;

			var vobj = ($("#picture").is(":visible") ? $("#picture") : $("#info"));
			vobj.fadeOut(FADEOUT_TIME, function()
			{
				if(picturesPos == pictures.length)										// Show info page
				{
					picturesPos = 0;
					$("#info").fadeIn(FADEIN_TIME);
					pictureTimeoutId = setTimeout(loadPicture, INFO_TIMEOUT);
				}
				else																	// Show image
				{
					var pict = $("#picture");
					pict.width("auto");														// "Reset" size or otherwise the image won't be resized in the load event
					pict.height("auto");
					pict.attr("src", pictures[picturesPos].url);
				}
			});
		}
	</script>
</head>

<body>
	<img id="picture" src="" alt=""></img>

	<div id="info" class="pv_info">
		<h1>&nbsp;Tällä näytöllä näytetään kuvia Helsingin Sanomien verkkolehden sivuilta.</h1>

		<br>&nbsp;&nbsp;Alla ohje miten voit saada kuvan näytettäväksi tälle ruudulle:<br><br>

		<ul type="square">
			<li>Yhdistä mobiililaitteesi spaceify-nimiseen avoimeen langattomaan verkkoon.</li>
			<li>Käynnistä laitteesi webselain ja mene osoitteeseen <b>hs.fi</b>.</li>
			<li>Sivustoa selatessa joidenkin kuvien ylä- ja alareunaan ilmestyy vihreät tai punaiset reunukset. Klikkaamalla kuvaa näytetään se tällä näytöllä.</li>
		</ul>
	</div>
</body>
</html>
