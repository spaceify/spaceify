"use strict";function Logger(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyError:isNodeJs?require(apiPath+"spaceifyerror"):SpaceifyError,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig};var self=this;var errorc=new classes.SpaceifyError;var config=new classes.SpaceifyConfig;var output=true;var fileName="/tmp/debug.txt";self.INFO=1;self.ERROR=2;self.WARN=4;self.FORCE=8;self.RETURN=16;var labelStr={};labelStr[self.INFO]="[i] ";labelStr[self.ERROR]="[e] ";labelStr[self.WARN]="[w] ";labelStr[self.FORCE]="";var labels=self.INFO|self.ERROR|self.WARN|self.FORCE;var levels=self.INFO|self.ERROR|self.WARN|self.FORCE;self.info=function(){out(self.INFO,arguments)};self.error=function(){printErrors.apply(this,arguments)};self.warn=function(){out(self.WARN,arguments)};self.force=function(){out(self.FORCE,arguments)};var out=function(level){var strp,strs=arguments[1];var str="";for(var i=0;i<strs.length;i++){strp=typeof strs[i]=="string"?strs[i]:JSON.stringify(strs[i]);str+=(str!=""&&str!="\n"&&str!="\r"&&str!="\r\n"?" ":"")+strp}if(typeof str=="string")str=str.replace(/[\x00-\x09\x0b-\x0c\x0e-\x1f]/g,"");var label=labels&level?labelStr[level]:"";if(output&&levels&level||level==self.FORCE){var txt=label+str;isNodeJs?process.stdout.write(txt+"\n"):console.log(txt)}};var printErrors=function(err,printPath,printCode,printType){var message=errorc.errorToString(err,printPath,printCode);if(printType==self.ERROR)out.call(self,self.ERROR,[message]);else if(printType==self.FORCE)self.force(message);return message};self.setOptions=function(options){if(options.hasOwnProperty("output"))output=options.output;if(options.hasOwnProperty("infoLabel"))labels[self.INFO]=options.infoLabel;if(options.hasOwnProperty("errorLabel"))labels[self.ERROR]=options.errorLabel;if(options.hasOwnProperty("warnLabel"))labels[self.WARN]=options.warnLabel;if(options.hasOwnProperty("forceLabel"))labels[self.FORCE]=options.forceLabel;if(options.hasOwnProperty("labels"))labels=options.labels;if(options.hasOwnProperty("fileName"))fileName=options.fileName;if(options.hasOwnProperty("levels"))levels=options.levels}}if(typeof exports!=="undefined")module.exports=Logger;function BinaryRpcCommunicator(handleBinary){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var isApplication=typeof process!=="undefined"&&process.env.IS_REAL_SPACEIFY?false:true;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,SpaceifyError:isNodeJs?require(apiPath+"spaceifyerror"):SpaceifyError,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility,CallbackBuffer:isNodeJs?require(apiPath+"callbackbuffer"):CallbackBuffer};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var logger=new classes.Logger;var errorc=new classes.SpaceifyError;var utility=new classes.SpaceifyUtility;var callbackBuffer=new classes.CallbackBuffer;var callSequence=1;var exposedRpcMethods={};var eventListener=null;var binaryListener=null;var connectionListeners=[];var disconnectionListeners=[];var connections={};var latestConnectionId=null;var options={debug:true};self.exposeRpcMethod=function(name,object,method){try{exposedRpcMethods[name]={object:object,method:method}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.setConnectionListener=function(listener){if(typeof listener=="function")connectionListeners.push(listener)};self.setDisconnectionListener=function(listener){if(typeof listener=="function")disconnectionListeners.push(listener)};self.setBinaryListener=function(listener){binaryListener=typeof listener=="function"?listener:null};self.connectionExists=function(connectionId){if(typeof connectionId!=="undefined"&&connections.hasOwnProperty(connectionId))return true;else if(typeof connectionId==="undefined"&&connections.hasOwnProperty(latestConnectionId))return true;else return false};self.getConnection=function(connectionId){return connections[connectionId]};self.setOptions=function(opts){options.debug="debug"in opts?opts.debug:false;logger.setOptions({output:options.debug})};self.callRpc=function(methods,params,object,callback,connectionId){var callObject;var callObjects=[];var isBatch=false,currentId;var id=typeof connectionId!="undefined"?connectionId:latestConnectionId;logger.info("BinaryRpcCommunicator::callRpc() connectionId: "+connectionId);if(!self.connectionExists(connectionId))return;try{if(!(methods instanceof Array)){isBatch=false;params=[params];methods=[methods]}currentId=callSequence;for(var i=0;i<methods.length;i++){if(typeof callback=="function")callObject={jsonrpc:"2.0",method:methods[i],params:params[i],id:callSequence++};else callObject={jsonrpc:"2.0",method:methods[i],params:params[i]};callObjects.push(callObject);logger.info("  "+JSON.stringify(callObject))}if(typeof callback=="function")callbackBuffer.pushBack(currentId,object,callback)}catch(err){return typeof callback=="function"?callback(errorc.makeErrorObject(-32e3,"callRpc failed.","BinaryRpcCommunicator::callRpc"),null):false}var request=isBatch?callObjects:callObjects[0];sendMessage(request,id)};self.notifyAll=function(method,params){try{for(var key in connections){logger.info("BinaryRpcCommunicator::notifyAll() sending message to "+key);sendMessage({jsonrpc:"2.0",method:method,params:params,id:null},key)}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.getBufferedAmount=function(connectionId){return connections[connectionId].getBufferedAmount()};self.sendBinary=function(data,connectionId){logger.info("BinaryRpcCommunicator::sendBinary() "+data.byteLength);try{connections[connectionId].sendBinary(data)}catch(err){logger.error(err,true,true,logger.ERROR)}};var sendBinaryCall=function(callId,method,params,connectionId){var messageBuffer=new ArrayBuffer(8+4+callId.length+4+method.length+8+params.byteLength);var view=new DataView(messageBuffer);var messageArray=new Uint8Array(messageBuffer);view.setUint32(4,messageBuffer.byteLength-8);view.setUint32(8,callId.length);view.setUint32(8+4+callId.length,method.length);messageArray.subarray(8+4+callId.length+4+method.length+8,messageBuffer.byteLength).set(params)};var sendMessage=function(message,connectionId){try{connections[connectionId].send(JSON.stringify(message))}catch(err){logger.error(err,true,true,logger.ERROR)}};self.sendMessage=sendMessage;var sendResponse=function(err,result,id,connectionId){try{if(err){logger.error(["Exception in executing a RPC method.",err],true,true,logger.ERROR);sendMessage({jsonrpc:"2.0",error:err,id:id})}else sendMessage({jsonrpc:"2.0",result:result,id:id},connectionId)}catch(err){logger.error(err,true,true,logger.ERROR)}};var handleMessage=function(requestsOrResponses,connectionId){var isBatch=true;try{if(!(requestsOrResponses instanceof Array)){requestsOrResponses=[requestsOrResponses];isBatch=false}if(requestsOrResponses[0].method){if(isNodeJs)fibrous.run(function(){handleRPCCall.sync(requestsOrResponses,isBatch,connectionId)},function(err,data){});else handleRPCCall(requestsOrResponses,isBatch,connectionId)}else handleReturnValue(requestsOrResponses,isBatch)}catch(err){logger.error(err,true,true,logger.ERROR)}};var handleRPCCall=function(requests,isBatch,connectionId){logger.info("BinaryRpcCommunicator::handleRpcCall() connectionId: "+connectionId);var responses=[],result,r,onlyNotifications=true;for(r=0;r<requests.length;r++){logger.info("  REQUEST -> "+JSON.stringify(requests[r]));var requestId=requests[r].hasOwnProperty("id")?requests[r].id:null;var rpcParams=requests[r].hasOwnProperty("params")?requests[r].params:[];if(requestId!=null)onlyNotifications=false;if(!requests[r].jsonrpc||requests[r].jsonrpc!="2.0"||!requests[r].method){responses.push({jsonrpc:"2.0",error:{code:-32600,message:"The JSON sent is not a valid Request object."},id:null},connectionId);continue}if(rpcParams!=="undefined"&&rpcParams.constructor!==Array){responses.push({jsonrpc:"2.0",error:{code:-32602,message:"Invalid method parameter(s). Parameters must be placed inside an array."},id:requestId},connectionId);continue}if(!exposedRpcMethods.hasOwnProperty(requests[r].method)){responses.push({jsonrpc:"2.0",error:{code:-32601,message:"The method does not exist / is not available: "+requests[r].method+"."},id:requestId});continue}try{var rpcMethod=exposedRpcMethods[requests[r].method];rpcParams.push({requestId:requestId,connectionId:connectionId,origin:connections[connectionId].getOrigin(),isSecure:connections[connectionId].getIsSecure(),remotePort:connections[connectionId].getRemotePort(),remoteAddress:connections[connectionId].getRemoteAddress()});if(isNodeJs&&isApplication)result=rpcMethod.method.sync.apply(rpcMethod.object,rpcParams);else result=rpcMethod.method.apply(rpcMethod.object,rpcParams);if(requestId!=null)responses.push({jsonrpc:"2.0",result:typeof result==="undefined"?null:result,id:requestId})}catch(err){if(typeof err.constructor=="function")err=err.toString();if(requestId!=null)responses.push({jsonrpc:"2.0",error:err,id:requestId})}if(requestId!=null)logger.info("  RESPONSE <- "+JSON.stringify(responses[responses.length-1]));else logger.info("  NO RESPONSE SEND FOR NOTIFICATION")}if(!onlyNotifications&&responses.length==0)responses.push({jsonrpc:"2.0",error:{code:-32603,message:"Internal JSON-RPC error."},id:null});if(responses.length>0)sendMessage(isBatch?responses:responses[0],connectionId)};var handleReturnValue=function(responses,isBatch){logger.info("BinaryRpcCommunicator::handleReturnValue()");var error=null,result=null;try{if(isBatch){var processed=processBatchResponse(responses);callbackBuffer.callMethodAndPop(processed.smallestId,processed.errors,processed.results)}else{logger.info("  RESPONSE: "+JSON.stringify(responses[0]));if(!responses[0].jsonrpc||responses[0].jsonrpc!="2.0"||!responses[0].id||responses[0].result&&responses[0].error)return;if(responses[0].error)error=responses[0].error;if(responses[0].result)result=responses[0].result;callbackBuffer.callMethodAndPop(responses[0].id,error,result)}}catch(err){logger.error(err,true,true,logger.ERROR)}};var processBatchResponse=function(responses){var smallestId=-1;var errors={},results={};for(var r=0;r<responses.length;r++){logger.info("  RESPONSE: "+JSON.stringify(responses[r]));if(!responses[r].jsonrpc||responses[r].jsonrpc!="2.0"||!responses[r].id||responses[r].result&&responses[r].error)continue;smallestId=Math.max(smallestId,responses[r].id);if(responses[r].hasOwnProperty("error")){errors[responses[r].id]=responses[r].error;results[responses[r].id]=null}else if(responses[r].hasOwnProperty("result")){errors[responses[r].id]=null;results[responses[r].id]=results[r].result}}return{smallestId:smallestId,errors:errors,results:results}};var handleBinary=function(data,connectionId){var view=new DataView(data);var dataArray=new Uint8Array(data);var messageSize=view.getUint32(4);var messageType=view.getUint32(8);var idSize=view.getUint32(12);var id=dataArray.subarray(16,16+idSize);var idString=String.fromCharCode.apply(null,id);var methodSize=view.getUint32(16+idSize);var method=dataArray.subarray(16+idSize+4,16+idSize+4+methodSize);var methodString=String.fromCharCode.apply(null,method);var paramsSize=view.getUint32(16+idSize+4+methodSize+4);var params=dataArray.subarray(16+idSize+4+methodSize+4+4,16+idSize+4+methodSize+4+4+paramsSize)};self.setupPipe=function(firstId,secondId){logger.info("BinaryRpcCommunicator::setupPipe() between: "+firstId+" and "+secondId);if(!connections.hasOwnProperty(firstId)||!connections.hasOwnProperty(secondId))return;connections[firstId].setPipedTo(secondId);connections[secondId].setPipedTo(firstId)};self.onMessage=function(messageData,connection){logger.info("BinaryRpcCommunicator::onMessage("+typeof messageData+") "+messageData);try{var pipeTarget=connection.getPipedTo();if(pipeTarget!=null){connections[pipeTarget].send(messageData);return}if(messageData instanceof ArrayBuffer){handleBinary(messageData,connection.getId());return}try{messageData=JSON.parse(messageData);handleMessage(messageData,connection.getId())}catch(err){sendMessage({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},connection.getId())}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.addConnection=function(conn){try{if(!conn.getId())conn.setId(utility.generateRandomConnectionId(connections));connections[conn.getId()]=conn;conn.setEventListener(self);for(var i=0;i<connectionListeners.length;i++)connectionListeners[i](conn.getId());latestConnectionId=conn.getId();return conn.getId()}catch(err){logger.error(err,true,true,logger.ERROR)}};self.onDisconnected=function(connectionId){try{self.closeConnection(connectionId);for(var i=0;i<disconnectionListeners.length;i++)disconnectionListeners[i](connectionId)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.closeConnection=function(connectionId){try{if(connectionId in connections){connections[connectionId].close();delete connections[connectionId]}}catch(err){logger.error(err,true,true,logger.ERROR)}}}if(typeof exports!=="undefined"){module.exports=BinaryRpcCommunicator}function CallbackBuffer(initialListSize){var self=this;var callbacks=new Object;self.pushBack=function(id,object,method){callbacks[id]=[object,method,Date.now()]};self.callMethodAndPop=function(id,error,result){if(callbacks.hasOwnProperty(id)){callbacks[id][1].call(callbacks[id][0],error,result,id,Date.now()-callbacks[id][2]);delete callbacks[id]}else throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"}}}if(typeof exports!=="undefined"){module.exports=CallbackBuffer}function RpcCommunicator(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var isApplication=typeof process!=="undefined"&&process.env.IS_REAL_SPACEIFY?false:true;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,SpaceifyError:isNodeJs?require(apiPath+"spaceifyerror"):SpaceifyError,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility,CallbackBuffer:isNodeJs?require(apiPath+"callbackbuffer"):CallbackBuffer};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var logger=new classes.Logger;var errorc=new classes.SpaceifyError;var utility=new classes.SpaceifyUtility;var callbackBuffer=new classes.CallbackBuffer;var callSequence=1;var exposedRpcMethods={};var eventListener=null;var binaryListener=null;var connectionListeners=[];var disconnectionListeners=[];var connections={};var latestConnectionId=null;var options={debug:true};self.exposeRpcMethod=function(name,object,method){try{exposedRpcMethods[name]={object:object,method:method}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.setConnectionListener=function(listener){if(typeof listener=="function")connectionListeners.push(listener)};self.setDisconnectionListener=function(listener){if(typeof listener=="function")disconnectionListeners.push(listener)};self.setBinaryListener=function(listener){binaryListener=typeof listener=="function"?listener:null};self.connectionExists=function(connectionId){if(typeof connectionId!=="undefined"&&connections.hasOwnProperty(connectionId))return true;else if(typeof connectionId==="undefined"&&connections.hasOwnProperty(latestConnectionId))return true;else return false};self.getConnection=function(connectionId){return connections[connectionId]};self.setOptions=function(opts){options.debug="debug"in opts?opts.debug:false;logger.setOptions({output:options.debug})};self.callRpc=function(methods,params,object,callback,connectionId){var callObject;var callObjects=[];var isBatch=false,currentId;var id=typeof connectionId!="undefined"?connectionId:latestConnectionId;logger.info("RpcCommunicator::callRpc() connectionId: "+connectionId);if(!self.connectionExists(connectionId))return;try{if(!(methods instanceof Array)){isBatch=false;params=[params];methods=[methods]}currentId=callSequence;for(var i=0;i<methods.length;i++){if(typeof callback=="function")callObject={jsonrpc:"2.0",method:methods[i],params:params[i],id:callSequence++};else callObject={jsonrpc:"2.0",method:methods[i],params:params[i]};callObjects.push(callObject);logger.info("  "+JSON.stringify(callObject))}if(typeof callback=="function")callbackBuffer.pushBack(currentId,object,callback)}catch(err){return typeof callback=="function"?callback(errorc.makeErrorObject(-32e3,"callRpc failed.","RpcCommunicator::callRpc"),null):false}sendMessage(isBatch?callObjects:callObjects[0],id)};self.notifyAll=function(method,params){try{for(var key in connections){logger.info("RpcCommunicator::notifyAll() sending message to "+key);sendMessage({jsonrpc:"2.0",method:method,params:params,id:null},key)}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.getBufferedAmount=function(connectionId){return connections[connectionId].getBufferedAmount()};self.sendBinary=function(data,connectionId){logger.info("RPCCommunicator::sendBinary() "+data.byteLength);try{connections[connectionId].sendBinary(data)}catch(err){logger.error(err,true,true,logger.ERROR)}};var sendBinaryCall=function(callId,method,params,connectionId){var messageBuffer=new ArrayBuffer(8+4+callId.length+4+method.length+8+params.byteLength);var view=new DataView(messageBuffer);var messageArray=new Uint8Array(messageBuffer);view.setUint32(4,messageBuffer.byteLength-8);view.setUint32(8,callId.length);view.setUint32(8+4+callId.length,method.length);messageArray.subarray(8+4+callId.length+4+method.length+8,messageBuffer.byteLength).set(params)};var sendMessage=function(message,connectionId){try{connections[connectionId].send(JSON.stringify(message))}catch(err){logger.error(err,true,true,logger.ERROR)}};self.sendMessage=sendMessage;var sendResponse=function(err,result,id,connectionId){try{if(err){logger.error(["Exception in executing a RPC method.",err],true,true,logger.ERROR);sendMessage({jsonrpc:"2.0",error:err,id:id})}else sendMessage({jsonrpc:"2.0",result:result,id:id},connectionId)}catch(err){logger.error(err,true,true,logger.ERROR)}};var handleMessage=function(requestsOrResponses,connectionId){var isBatch=true;try{if(!(requestsOrResponses instanceof Array)){requestsOrResponses=[requestsOrResponses];isBatch=false}if(requestsOrResponses[0].method){if(isNodeJs)fibrous.run(function(){handleRPCCall.sync(requestsOrResponses,isBatch,connectionId)},function(err,data){});else handleRPCCall(requestsOrResponses,isBatch,connectionId)}else handleReturnValue(requestsOrResponses,isBatch)}catch(err){logger.error(err,true,true,logger.ERROR)}};var handleRPCCall=function(requests,isBatch,connectionId){logger.info("RpcCommunicator::handleRpcCall() connectionId: "+connectionId);var responses=[],result,r,onlyNotifications=true;for(r=0;r<requests.length;r++){logger.info("  REQUEST -> "+JSON.stringify(requests[r]));var requestId=requests[r].hasOwnProperty("id")?requests[r].id:null;var rpcParams=requests[r].hasOwnProperty("params")?requests[r].params:[];if(requestId!=null)onlyNotifications=false;if(!requests[r].jsonrpc||requests[r].jsonrpc!="2.0"||!requests[r].method){responses.push({jsonrpc:"2.0",error:{code:-32600,message:"The JSON sent is not a valid Request object."},id:null},connectionId);continue}if(rpcParams!=="undefined"&&rpcParams.constructor!==Array){responses.push({jsonrpc:"2.0",error:{code:-32602,message:"Invalid method parameter(s). Parameters must be placed inside an array."},id:requestId},connectionId);continue}if(!exposedRpcMethods.hasOwnProperty(requests[r].method)){responses.push({jsonrpc:"2.0",error:{code:-32601,message:"The method does not exist / is not available: "+requests[r].method+"."},id:requestId});continue}try{var rpcMethod=exposedRpcMethods[requests[r].method];rpcParams.push({requestId:requestId,connectionId:connectionId,origin:connections[connectionId].getOrigin(),isSecure:connections[connectionId].getIsSecure(),remotePort:connections[connectionId].getRemotePort(),remoteAddress:connections[connectionId].getRemoteAddress()});if(isNodeJs&&isApplication)result=rpcMethod.method.sync.apply(rpcMethod.object,rpcParams);else result=rpcMethod.method.apply(rpcMethod.object,rpcParams);if(requestId!=null)responses.push({jsonrpc:"2.0",result:typeof result==="undefined"?null:result,id:requestId})}catch(err){if(typeof err=="function")err=err.toString();if(requestId!=null)responses.push({jsonrpc:"2.0",error:err,id:requestId})}if(requestId!=null)logger.info("  RESPONSE <- "+JSON.stringify(responses[responses.length-1]));else logger.info("  NO RESPONSE SEND FOR NOTIFICATION")}if(!onlyNotifications&&responses.length==0)responses.push({jsonrpc:"2.0",error:{code:-32603,message:"Internal JSON-RPC error."},id:null});if(responses.length>0)sendMessage(isBatch?responses:responses[0],connectionId)};var handleReturnValue=function(responses,isBatch){logger.info("RpcCommunicator::handleReturnValue()");var error=null,result=null;try{if(isBatch){var processed=processBatchResponse(responses);callbackBuffer.callMethodAndPop(processed.smallestId,processed.errors,processed.results)}else{logger.info("  RESPONSE: "+JSON.stringify(responses[0]));if(!responses[0].jsonrpc||responses[0].jsonrpc!="2.0"||!responses[0].id||responses[0].result&&responses[0].error)return;if(responses[0].error)error=responses[0].error;if(responses[0].result)result=responses[0].result;callbackBuffer.callMethodAndPop(responses[0].id,error,result)}}catch(err){logger.error(err,true,true,logger.ERROR)}};var processBatchResponse=function(responses){var smallestId=-1;var errors={},results={};for(var r=0;r<responses.length;r++){logger.info("  RESPONSE: "+JSON.stringify(responses[r]));if(!responses[r].jsonrpc||responses[r].jsonrpc!="2.0"||!responses[r].id||responses[r].result&&responses[r].error)continue;smallestId=Math.max(smallestId,responses[r].id);if(responses[r].hasOwnProperty("error")){errors[responses[r].id]=responses[r].error;results[responses[r].id]=null}else if(responses[r].hasOwnProperty("result")){errors[responses[r].id]=null;results[responses[r].id]=results[r].result}}return{smallestId:smallestId,errors:errors,results:results}};self.setupPipe=function(firstId,secondId){logger.info("RpcCommunicator::setupPipe() between: "+firstId+" and "+secondId);if(!connections.hasOwnProperty(firstId)||!connections.hasOwnProperty(secondId))return;connections[firstId].setPipedTo(secondId);connections[secondId].setPipedTo(firstId)};self.onMessage=function(messageData,connection){try{var pipeTarget=connection.getPipedTo();if(pipeTarget!=null){connections[pipeTarget].send(messageData);return}if(messageData instanceof ArrayBuffer){if(typeof binaryListener=="function")binaryListener.onBinary(messageData,connection.getId());return}try{messageData=JSON.parse(messageData);handleMessage(messageData,connection.getId())}catch(err){sendMessage({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},connection.getId())}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.addConnection=function(conn){try{if(!conn.getId())conn.setId(utility.generateRandomConnectionId(connections));connections[conn.getId()]=conn;conn.setEventListener(self);for(var i=0;i<connectionListeners.length;i++)connectionListeners[i](conn.getId());latestConnectionId=conn.getId();return conn.getId()}catch(err){logger.error(err,true,true,logger.ERROR)}};self.onDisconnected=function(connectionId){try{self.closeConnection(connectionId);for(var i=0;i<disconnectionListeners.length;i++)disconnectionListeners[i](connectionId)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.closeConnection=function(connectionId){try{if(connectionId in connections){connections[connectionId].close();delete connections[connectionId]}}catch(err){logger.error(err,true,true,logger.ERROR)}}}if(typeof exports!=="undefined"){module.exports=RpcCommunicator}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;function WebRtcClient(rtcConfig){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,RpcCommunicator:isNodeJs?require(apiPath+"rpccommunicator"):RpcCommunicator,WebSocketConnection:isNodeJs?require(apiPath+"websocketconnection"):WebSocketConnection};var self=this;var logger=new classes.Logger;var config=new classes.SpaceifyConfig;var communicator=new classes.RpcCommunicator;var connection=new classes.WebSocketConnection;var ownStream=null;var connectionListener=null;var rtcConnections=new Object;self.setConnectionListener=function(lis){connectionListener=lis};self.onIceCandidate=function(iceCandidate,partnerId){logger.info("WebRtcClient::onIceCandidate - Got it, sending it to the other client");communicator.callRpc("offerIce",[iceCandidate,partnerId])};var createConnection=function(partnerId){rtcConnections[partnerId]=new WebRtcConnection(rtcConfig);rtcConnections[partnerId].setPartnerId(partnerId);rtcConnections[partnerId].setIceListener(self);rtcConnections[partnerId].setStreamListener(self);rtcConnections[partnerId].setConnectionListener(self);rtcConnections[partnerId].setDataChannelListener(self)};self.shutdown=function(e){logger.info("WebRtcClient::onbeforeunload");for(var id in rtcConnections){if(rtcConnections.hasOwnProperty(id)){rtcConnections[id].close();delete rtcConnections[id]}}};self.handleRtcOffer=function(descriptor,partnerId,connectionId){logger.info("WebRtcClient::handleRtcOffer descriptor:",descriptor);if(!rtcConnections.hasOwnProperty(partnerId)){createConnection(partnerId)}rtcConnections[partnerId].onConnectionOfferReceived(descriptor,connectionId,function(answer){logger.info("WebRtcClient::handleRtcOffer - onConnectionOfferReceived returned");communicator.callRpc("acceptConnectionOffer",[answer,partnerId])})};self.handleRtcAnswer=function(descriptor,partnerId,connectionId){logger.info("WebRtcClient::handleRtcAnswer");rtcConnections[partnerId].onConnectionAnswerReceived(descriptor)};self.handleIceCandidate=function(iceCandidate,partnerId,connectionId){logger.info("WebRtcClient::handleIceCandidate");if(!rtcConnections.hasOwnProperty(partnerId)){createConnection(partnerId)}rtcConnections[partnerId].onIceCandidateReceived(iceCandidate)};var connectToCoordinator=function(config,callback){logger.info("WebRtcClient::connectToCoordinator","> Websocket connecting to the coordinator");connection.connect(config,function(){logger.info("WebRtcClient::connectToCoordinator - Websocket Connected to the Coordinator");logger.info("> Creating RPCCommunicator for the Websocket");communicator.addConnection(connection);callback()})};self.onDisconnected=function(partnerId){logger.info("WebRtcClient::onDisconnected");if(rtcConnections.hasOwnProperty(partnerId)){var connection=rtcConnections[partnerId];connectionListener.onDisconnected(connection.getId());connection.close();delete rtcConnections[partnerId]}};self.onDataChannelOpen=function(connection){logger.info("WebRtcClient::onDataChannelOpen");connectionListener.addConnection(connection)};self.onStream=function(stream,partnerId){logger.info("WebRtcClient::onStream")};self.onRemoveStream=function(stream,partnerId){logger.info("WebRtcClient::onRemoveStream");self.onDisconnected(partnerId)};var connectToPeers=function(announceId,callback){logger.info("WebRtcClient::connectToPeers - Announcing to the Coordinator");communicator.callRpc("announce",[announceId],self,self.onPeerIdsArrived)};self.onPeerIdsArrived=function(err,data,id){logger.info("WebRtcClient::onPeerIdsArrived - data.length:",data.length);var partnerId=0;for(var i=0;i<data.length;i++){partnerId=data[i];createConnection(partnerId);logger.info("WebRtcClient::onPeerIdsArrived - Trying to create offer to client id",partnerId);rtcConnections[partnerId].createConnectionOffer(function(offer,peerId){logger.info("WebRtcClient::onPeerIdsArrived - Offer created, sending it to the other client",peerId);communicator.callRpc("offerConnection",[offer,peerId])})}if(data.length===0)logger.info("> Announce returned 0 client ids, not connecting")};self.run=function(config,callback){logger.info("WebRtcClient::run");window.onbeforeunload=self.shutdown;communicator.exposeRpcMethod("handleRtcOffer",self,self.handleRtcOffer);communicator.exposeRpcMethod("handleRtcAnswer",self,self.handleRtcAnswer);communicator.exposeRpcMethod("handleIceCandidate",self,self.handleIceCandidate);connectToCoordinator(config,function(){logger.info("WebRtcClient::run - Connected to the coordinator");connectToPeers(config.announceId,function(){logger.info("WebRtcClient::run - connectToPeers returned")});if(callback)callback(communicator)})}}var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;var RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;function WebRtcConnection(rtcConfig){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger};var self=this;var logger=new classes.Logger;var id=null;var ownStream=null;var partnerId=null;var iceListener=null;var streamListener=null;var listener=null;var eventListener=null;var dataChannelListener=null;var rtcOptions={optional:[{DtlsSrtpKeyAgreement:true}]};var peerConnection=new RTCPeerConnection(rtcConfig,rtcOptions);var dataChannel=null;peerConnection.ondatachannel=function(e){var temp=e.channel||e;logger.info("WebRtcConnection::peerConnection.ondatachannel",e);dataChannel=temp;dataChannel.binaryType="arraybuffer";dataChannel.onopen=self.onDataChannelOpen;dataChannel.onmessage=self.onMessage};var onsignalingstatechange=function(state){logger.info("WebRtcConnection::onsignalingstatechange",state)};var oniceconnectionstatechange=function(state){logger.info("WebRtcConnection::oniceconnectionstatechange",state);if(eventListener=="function"&&(peerConnection.iceConnectionState=="disconnected"||peerConnection.iceConnectionState=="closed"))eventListener.onDisconnected(partnerId)};var onicegatheringstatechange=function(state){logger.info("WebRtcConnection::onicegatheringstatechange",state)};var onIceCandidate=function(e){logger.info("WebRtcConnection::onIceCanditate - partnerId:",partnerId,", event:",e,"> iceListener was",iceListener);if(e.candidate==null){logger.info("> All Ice candidates listed")}else{iceListener.onIceCandidate(e.candidate,partnerId)}};peerConnection.onsignalingstatechange=onsignalingstatechange;peerConnection.oniceconnectionstatechange=oniceconnectionstatechange;peerConnection.onicegatheringstatechange=onicegatheringstatechange;peerConnection.onicecandidate=onIceCandidate;self.close=function(){logger.info("WebRtcConnection::close");dataChannel.close();if(peerConnection.signalingState!="closed")peerConnection.close()};self.send=function(message){try{if(dataChannel.readyState=="open")dataChannel.send(message)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.getBufferedAmount=function(){return dataChannel.bufferedAmount};self.sendBinary=function(data){try{if(dataChannel.readyState=="open")dataChannel.send(data)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.onDataChannelClosed=function(e){logger.info("WebRtcConnection::onDataChannelClosed",e);eventListener.onDisconnected(self);
};self.onDataChannelOpen=function(e){logger.info("WebRtcConnection::onDataChannelOpen",e);dataChannel.binaryType="arraybuffer";dataChannel.onclose=self.onDataChannelClosed;dataChannel.onmessage=self.onMessage;if(dataChannelListener)dataChannelListener.onDataChannelOpen(self)};self.onMessage=function(message){try{if(listener)listener.onMessage(message.data,self)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.setId=function(id_){id=id_};self.getId=function(){return id};self.getPartnerId=function(){return partnerId};self.setPartnerId=function(id_){partnerId=id_};self.setDataChannelListener=function(lis){dataChannelListener=lis};self.setListener=function(lis){listener=lis};self.setIceListener=function(lis){iceListener=lis;logger.info("WebRtcConnection::setIceListener",lis)};self.setStreamListener=function(lis){streamListener=lis;peerConnection.onaddstream=function(e){self.onStream(e)};peerConnection.onremovestream=function(e){self.onRemoveStream(e)}};self.setEventListener=function(lis){eventListener=lis};self.onStream=function(e){logger.info("WebRtcConnection::onStream",e);streamListener.onStream(e.stream,partnerId)};self.onRemoveStream=function(e){logger.info("WebRtcConnection::onStream",e);streamListener.onRemoveStream(e.stream,partnerId)};self.addStream=function(stream){ownStream=stream;peerConnection.addStream(stream)};self.createConnectionOffer=function(callback){var localDescription=null;dataChannel=peerConnection.createDataChannel("jsonrpcchannel",{reliable:true});dataChannel.binaryType="arraybuffer";dataChannel.onopen=self.onDataChannelOpen;dataChannel.onmessage=self.onMessage;peerConnection.createOffer(function(desc){logger.info("WebRtcConnection::peerConnectio.createOffer - Called its callback:",desc);localDescription=desc;peerConnection.setLocalDescription(desc,function(){callback(peerConnection.localDescription,partnerId)},function(err){logger.error(err,true,true,logger.ERROR)},{})},function(err){logger.error(err,true,true,logger.ERROR)})};self.onConnectionAnswerReceived=function(descriptor){logger.info("WebRtcConnection::onConnectionAnswerReceived, descriptor:",descriptor);peerConnection.setRemoteDescription(new RTCSessionDescription(descriptor),function(){logger.info("WebRtcConnection::onConnectionAnswerReceived() - setRemoteDescription returned OK")},function(err){logger.error(err,true,true,logger.ERROR)})};self.onConnectionOfferReceived=function(descriptor,connectionId,callback){logger.info("WebRtcConnection::onConnectionOfferReceived - Trying to set remote description");var desc=new RTCSessionDescription(descriptor);peerConnection.setRemoteDescription(desc,function(){logger.info("WebRtcConnection::onConnectionOfferReceived Remote description set");peerConnection.createAnswer(function(answer){peerConnection.setLocalDescription(answer,function(){callback(peerConnection.localDescription)},function(err){logger.error(err,true,true,logger.ERROR)})},function(err){logger.error(err,true,true,logger.ERROR)})},function(err){logger.error(err,true,true,logger.ERROR)})};self.onIceCandidateReceived=function(iceCandidate){peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate),function(){logger.info("WebRtcConnection::onIceCandidateReceived - Adding Ice candidate succeeded")},function(err){logger.error(err,true,true,logger.ERROR)})};self.setPipedTo=function(targetId){};self.getPipedTo=function(){return null}}function WebSocketConnection(){if(typeof exports!=="undefined"){global.fs=require("fs");global.WebSocket=require("websocket").w3cwebsocket}var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,SpaceifyError:isNodeJs?require(apiPath+"spaceifyerror"):SpaceifyError};var self=this;var logger=new classes.Logger;var errorc=new classes.SpaceifyError;var url="";var id=null;var port=null;var socket=null;var origin=null;var pipedTo=null;var isOpen=false;var isSecure=false;var remotePort=null;var remoteAddress=null;var eventListener=null;self.connect=function(opts,callback){id=opts.id||null;port=opts.port||"";isSecure=opts.isSecure||false;var caCrt=opts.caCrt||"";var hostname=opts.hostname||null;var protocol=!isSecure?"ws":"wss";var subprotocol=opts.subprotocol||"json-rpc";var debug="debug"in opts?opts.debug:false;logger.setOptions({output:debug});try{url=protocol+"://"+hostname+(port?":"+port:"")+(id?"?id="+id:"");var cco=isNodeJs&&isSecure?{tlsOptions:{ca:[fs.readFileSync(caCrt,"utf8")]}}:null;socket=new WebSocket(url,"json-rpc",null,null,null,cco);socket.binaryType="arraybuffer";socket.onopen=function(){logger.info("WebSocketConnection::onOpen() "+url);isOpen=true;callback(null,true)};socket.onerror=function(err){logger.error("WebSocketConnection::onError() "+url,true,true,logger.ERROR);isOpen=false;callback(errorc.makeErrorObject("wsc","Failed to open WebsocketConnection.","WebSocketConnection::connect"),null)};socket.onclose=function(reasonCode,description){onSocketClosed(reasonCode,description,self)};socket.onmessage=onMessageEvent}catch(err){callback(err,null)}};self.setSocket=function(val){try{socket=val;socket.on("message",onMessage);socket.on("close",function(reasonCode,description){onSocketClosed(reasonCode,description,self)});isOpen=true}catch(err){logger.error(err,true,true,logger.ERROR)}};self.setId=function(val){id=val};self.setPipedTo=function(targetId){pipedTo=targetId};self.setRemoteAddress=function(val){remoteAddress=val};self.setRemotePort=function(val){remotePort=val};self.setOrigin=function(val){origin=val};self.setIsSecure=function(val){isSecure=val};self.setEventListener=function(listener){eventListener=listener};self.getId=function(){return id};self.getRemoteAddress=function(){return remoteAddress};self.getRemotePort=function(){return remotePort};self.getOrigin=function(){return origin};self.getIsSecure=function(){return isSecure};self.getPipedTo=function(){return pipedTo};self.getIsOpen=function(){return isOpen};self.getPort=function(){return port};var onMessage=function(message){try{if(eventListener){if(message.type=="utf8"){logger.info("WebSocketConnection::onMessage(string): "+JSON.stringify(message.utf8Data));eventListener.onMessage(message.utf8Data,self)}if(message.type=="binary"){logger.info("WebSocketConnection::onMessage(binary): "+binaryData.length);eventListener.onMessage(message.binaryData,self)}}}catch(err){logger.error(err,true,true,logger.ERROR)}};var onMessageEvent=function(event){logger.info("WebSocketConnection::onMessageEvent() "+JSON.stringify(event.data));try{if(eventListener)eventListener.onMessage(event.data,self)}catch(err){logger.error(err,true,true,logger.ERROR)}};var onSocketClosed=function(reasonCode,description,obj){logger.info("WebSocketConnection::onSocketClosed() "+url);try{isOpen=false;if(eventListener)eventListener.onDisconnected(obj.getId())}catch(err){logger.error(err,true,true,logger.ERROR)}};self.send=function(message){try{socket.send(message)}catch(err){logger.error(err,true,true,logger.ERROR)}};self.sendBinary=self.send;self.close=function(){try{socket.close()}catch(err){logger.error(err,true,true,logger.ERROR)}}}if(typeof exports!=="undefined"){module.exports=WebSocketConnection}function WebSocketRpcConnection(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyError:isNodeJs?require(apiPath+"spaceifyerror"):SpaceifyError,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility,RpcCommunicator:isNodeJs?require(apiPath+"rpccommunicator"):RpcCommunicator,WebSocketConnection:isNodeJs?require(apiPath+"websocketconnection"):WebSocketConnection};var self=this;var errorc=new classes.SpaceifyError;var utility=new classes.SpaceifyUtility;var communicator=new classes.RpcCommunicator;var connection=new classes.WebSocketConnection;self.connect=function(options,callback){connection.connect(options,function(err,data){if(!err){communicator.addConnection(connection);var debug="debug"in options?options.debug:false;communicator.setOptions({debug:debug});if(callback)callback(null,true)}else{if(callback)callback(errorc.makeErrorObject("wsrpcc","Failed to open WebsocketRpcConnection.","WebSocketRpcConnection::connect"),null)}})};self.close=function(){};self.getCommunicator=function(){return communicator};self.getConnection=function(){return connection};self.exposeRpcMethod=function(name,object,method){communicator.exposeRpcMethod(name,object,method)};self.callRpc=function(method,params,object,listener){return communicator.callRpc(method,params,object,listener,connection.getId())};self.getIsOpen=function(){return connection.getIsOpen()};self.getIsSecure=function(){return connection.getIsSecure()};self.getPort=function(){return connection.getPort()};self.setConnectionListener=function(listener){communicator.setConnectionListener(listener)};self.setDisconnectionListener=function(listener){communicator.setDisconnectionListener(listener)}}if(typeof exports!=="undefined"){module.exports=WebSocketRpcConnection}function WebSocketServer(){if(typeof exports!=="undefined"){global.fs=require("fs");global.URL=require("url");global.http=require("http");global.https=require("https");global.WSServer=require("websocket").server}var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility.js"):SpaceifyUtility,WebSocketConnection:isNodeJs?require(apiPath+"websocketconnection"):WebSocketConnection};var self=this;var logger=new classes.Logger;var config=new classes.SpaceifyConfig;var utility=new classes.SpaceifyUtility;var options={};var manuallyClosed=false;var serverDownTimerId=null;var wsServer=null;var webServer=null;var eventListener=null;var externalServerUpListener=null;var externalServerDownListener=null;self.listen=function(opts,callback){try{if(!("id"in options)){options.hostname=opts.hostname||null;options.port=opts.port||"";options.key=opts.key||"";options.crt=opts.crt||"";options.caCrt=opts.caCrt||"";options.isSecure=opts.isSecure||false;options.keepUp=opts.keepUp||"";options.protocol=!options.isSecure?"ws":"wss";options.subprotocol=opts.subprotocol||"json-rpc";options.debug="debug"in opts?opts.debug:false;options.id=opts.id||utility.generateRandomConnectionId({})}logger.setOptions({output:options.debug});logger.info(utility.replace("WebSocketServer::listen() protocol: ~pr, subprotocol: ~s, hostname: ~h, port: ~po",{"~pr":options.protocol,"~s":options.subprotocol,"~h":options.hostname,"~po":options.port}));manuallyClosed=false;if(!options.isSecure){webServer=http.createServer(function(request,response){response.writeHead(501);response.end("Not implemented")})}else{var key=fs.readFileSync(options.key);var crt=fs.readFileSync(options.crt);var caCrt=fs.readFileSync(options.caCrt,"utf8");webServer=https.createServer({key:key,cert:crt,ca:caCrt},function(request,response){response.writeHead(501);response.end("Not implemented")})}webServer.listen(options.port,options.hostname,511,function(){serverUpListener();if(typeof callback=="function")callback(null,true)});webServer.on("error",function(err){logger.error("WebSocketServer::onError()",true,true,logger.ERROR);serverDownListener();if(typeof callback=="function")callback(err,null)});webServer.on("close",function(){serverDownListener()});wsServer=new WSServer({httpServer:webServer,autoAcceptConnections:false,keepalive:true,keepaliveInterval:6e4,dropConnectionOnKeepaliveTimeout:true,keepaliveGracePeriod:1e4});wsServer.on("request",function(request){try{var connection=new classes.WebSocketConnection;connection.setSocket(request.accept(options.subprotocol,request.origin));connection.setRemoteAddress(request.remoteAddress);connection.setRemotePort(request.remotePort);connection.setOrigin(request.origin);connection.setIsSecure(options.isSecure);var query=URL.parse(request.resourceURL,true).query;if(query&&query.id)connection.setId(query.id);eventListener.addConnection(connection);logger.info(utility.replace("WebSocketServer::request() protocol: ~p, remoteAddress: ~ra, remotePort: ~rp, origin: ~o, id: ~i",{"~p":options.protocol,"~ra":request.remoteAddress,"~rp":request.remotePort,"~o":request.origin,"~i":connection.getId()},"-"))}catch(err){logger.error(err,true,true,logger.ERROR);return}});wsServer.on("connect",function(webSocketConnection){});wsServer.on("close",function(webSocketConnection,closeReason,description){})}catch(err){logger.error(err,true,true,logger.ERROR)}};self.close=function(){try{logger.info(utility.replace("WebSocketServer::close() protocol: :pr, subprotocol: :s, hostname: :h, port: :po",{":pr":options.protocol,":s":options.subprotocol,":h":options.hostname,":po":options.port}));manuallyClosed=true;if(wsServer){wsServer.shutDown();wsServer=null}if(webServer){webServer.close();webServer=null}}catch(err){logger.error(err,true,true,logger.ERROR)}};self.getPort=function(){return options.port};self.getIsOpen=function(){return webServer&&wsServer?true:false};self.getIsSecure=function(){return options.isSecure};self.getId=function(){return options.id};self.setEventListener=function(listener){eventListener=listener};var serverUpListener=function(){if(externalServerUpListener)externalServerUpListener(options.id)};var serverDownListener=function(){if(externalServerDownListener)externalServerDownListener(options.id);if(options.keepUp&&serverDownTimerId==null&&!manuallyClosed){serverDownTimerId=setTimeout(function(){serverDownTimerId=null;self.listen(options,null)},config.RECONNECT_WAIT)}};self.setServerUpListener=function(listener){externalServerUpListener=typeof listener=="function"?listener:null};self.setServerDownListener=function(listener){externalServerDownListener=typeof listener=="function"?listener:null}}if(typeof exports!=="undefined"){module.exports=WebSocketServer}function WebSocketRpcServer(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,RpcCommunicator:isNodeJs?require(apiPath+"rpccommunicator"):RpcCommunicator,WebSocketServer:isNodeJs?require(apiPath+"websocketserver"):WebSocketServer};var self=this;var config=new classes.SpaceifyConfig;var communicator=new classes.RpcCommunicator;var webSocketServer=new classes.WebSocketServer;webSocketServer.setEventListener(communicator);self.listen=function(options,callback){var debug="debug"in options?options.debug:false;communicator.setOptions({debug:debug});try{webSocketServer.listen(options,callback)}catch(err){}};self.close=function(){webSocketServer.close()};self.getCommunicator=function(){return communicator};self.getServer=function(){return webSocketServer};self.getPort=function(){return webSocketServer.getPort()};self.getIsOpen=function(){return webSocketServer.getIsOpen()};self.getIsSecure=function(){return webSocketServer.getIsSecure()};self.getId=function(){return webSocketServer.getId()};self.exposeRpcMethod=function(name,object,method){communicator.exposeRpcMethod(name,object,method)};self.nofifyAll=function(method,params){communicator.nofifyAll(method,params)};self.callRpc=function(){communicator.callRpc.apply(this,arguments)};self.setConnectionListener=function(listener){communicator.setConnectionListener(listener)};self.setDisconnectionListener=function(listener){communicator.setDisconnectionListener(listener)};self.setServerUpListener=function(listener){webSocketServer.setServerUpListener(typeof listener=="function"?listener:null)};self.setServerDownListener=function(listener){webSocketServer.setServerDownListener(typeof listener=="function"?listener:null)}}if(typeof exports!=="undefined")module.exports=WebSocketRpcServer;function SpaceifyApplicationManager(){var self=this;var errorc=new SpaceifyError;var config=new SpaceifyConfig;var network=new SpaceifyNetwork;var utility=new SpaceifyUtility;var id=-1;var ms=-1;var locked=false;var readySequence=0;var type=null;var params=null;var origin=null;var readyErr=null;var readyData=null;var setupMessaging=true;var operationHandler=null;var spaceifyMessages=new SpaceifyMessages;self.installApplication=function(applicationPackage,username,password,force,origin,handler){setup("installApplication",{"package":applicationPackage,username:username,password:password,force:force},origin,handler)};self.removeApplication=function(unique_name,origin,handler){setup("removeApplication",{unique_name:unique_name},origin,handler)};self.startApplication=function(unique_name,origin,handler){setup("startApplication",{unique_name:unique_name},origin,handler)};self.stopApplication=function(unique_name,origin,handler){setup("stopApplication",{unique_name:unique_name},origin,handler)};self.restartApplication=function(unique_name,origin,handler){setup("restartApplication",{unique_name:unique_name},origin,handler)};self.logIn=function(password,origin,handler){setupMessaging=false;setup("logIn",{password:password},origin,handler)};self.logOut=function(origin,handler){setupMessaging=false;setup("logOut",{},origin,handler)};self.isAdminLoggedIn=function(origin,handler){setup("isAdminLoggedIn",{},origin,handler)};self.getSettings=function(origin,handler){setup("getSettings",{},origin,handler)};self.saveSettings=function(settings,origin,handler){setup("saveSettings",{settings:settings},origin,handler)};self.getServiceRuntimeStates=function(origin,handler){setup("getServiceRuntimeStates",{},origin,handler)};self.getApplications=function(types,origin,handler){setup("getApplications",{types:types},origin,handler)};self.appStoreGetPackages=function(search,returnCallback){var search=JSON.stringify(search);var content='Content-Disposition: form-data; name="search";\r\nContent-Type: plain/text; charset=utf-8';network.POST_FORM(config.EDGE_APPSTORE_GET_PACKAGES_URL,[{content:content,data:search}],"application/json",function(err,response){var err=data=null;try{data=JSON.parse(response.replace(/&quot;/g,'"'));if(data.error){err=data.error;data=null}}catch(err){err=errorc.makeErrorObject("JSON","Failed to get packages: JSON.parse failed","SpaceifyApplicationManager::appStoreGetPackages")}returnCallback(err,data)})};var setup=function(type_,params_,origin_,handler){type=type_;ms=Date.now();params=params_;origin=origin_;operationHandler=handler;id=utility.randomString(16,true);if(locked)origin.error(errorc.makeErrorObject("locked","Application manager is locked.","SpaceifyApplicationManager::setup"),null);else{if(setupMessaging){readySequence=0;spaceifyMessages.connect(self,origin)}else{readySequence=1;self.success()}}};self.fail=function(err){readyErr=err;readyData=null;setupMessaging=true;self.ready(2)};self.success=function(){locked=true;setupMessaging=true;var post={type:type};for(var i in params)post[i]=params[i];network.POST_JSON(config.OPERATION_URL,post,function(err,data){readyErr=err;readyData=data;self.ready(1)})};self.ready=function(sequence){readySequence+=sequence;if(readySequence!=2)return;locked=false;var errors=spaceifyMessages.getErrors();if(readyErr||errors.length>0)origin.error(readyErr?[readyErr]:errors,id,Date.now()-ms);else if(typeof operationHandler=="function")operationHandler(readyData,id,Date.now()-ms)};self.answer=function(result,answerCallBackId){spaceifyMessages.answer(result,answerCallBackId)}}function SpaceifySynchronous(){var self=this;var methodId=0;var methods=[];var results={};var waiting=null;var finally_=null;self.waterFall=function(_methods,callback){if((!_methods||_methods.length==0)&&typeof callback=="function")callback(results);else if(!_methods||_methods.length==0||typeof callback!="function")return;finally_=callback;methods=_methods;next()};var next=function(){if(methods.length==0)return finally_();var calling=methods.shift();if(calling.type=="async"){waiting=calling.params[calling.params.length-1];calling.params[calling.params.length-1]=wait;calling.method.apply(calling.object,calling.params)}else{results[++methodId]=calling.method.apply(calling.object,calling.params);next()}};var wait=function(){results[++methodId]=Array.prototype.slice.call(arguments);if(typeof waiting=="function")waiting.apply(this,arguments);next()};self.getResult=function(methodId){return results[methodId]?results[methodId]:null};self.getResults=function(){return results}}if(typeof exports!=="undefined")module.exports=SpaceifySynchronous;function SpaceifyCache(){var self=this;var ready_counter=0;var applications={};var EXPIRATION_TIME=60*1e3;var config=new SpaceifyConfig;self.setApplication=function(application){if(!applications[application.unique_name])applications[application.unique_name]={};applications[application.unique_name].manifest=application;applications[application.unique_name].isRunning=application.isRunning};self.getApplication=function(unique_name){return unique_name in applications?applications[unique_name]:null};self.setService=function(service,unique_name){if(service.service_type!=config.HTTP)return;if(!applications[unique_name])applications[unique_name]={};if(!applications[unique_name].services)applications[unique_name].services=[];applications[unique_name].services.push(service)};self.getService=function(service_name,unique_name){for(var aun in applications){var services=applications[aun].services?applications[aun].services:[];for(var s=0;s<services.length;s++){var asn=services[s].service_name;if(!unique_name&&service_name==asn&&service_name!=config.HTTP||unique_name&&unique_name==aun&&service_name==asn)return services[s]}}return null};self.setManifest=function(unique_name,manifest){if(!applications[unique_name])applications[unique_name]={};applications[unique_name].manifest=manifest};self.getManifest=function(unique_name){return applications[unique_name]&&applications[unique_name].manifest?applications[unique_name].manifest:null};self.setRunning=function(unique_name,isRunning){if(!applications[unique_name])applications[unique_name]={};applications[unique_name].isRunning=isRunning;applications[unique_name].isRunningStart=Date.now()};self.isRunning=function(unique_name){if(!applications[unique_name]||!applications[unique_name].hasOwnProperty("isRunning"))return null;var run_time=Date.now()-applications[unique_name].isRunningStart;return run_time>EXPIRATION_TIME?null:applications[unique_name].isRunning};self.setApplicationURL=function(unique_name,urls){if(!applications[unique_name])applications[unique_name]={};applications[unique_name].urls=urls;applications[unique_name].urls_start=Date.now()};self.getApplicationURL=function(unique_name){if(!applications[unique_name]||!applications[unique_name].hasOwnProperty("urls"))return null;var urls_time=Date.now()-applications[unique_name].urls_start;return urls_time>EXPIRATION_TIME?null:applications[unique_name].urls}}function SpaceifyConfig(){var self=this;if(typeof exports!=="undefined"){var i,file=require("fs").readFileSync((process.env.IS_REAL_SPACEIFY?"/api/www/libs/":"www/libs/")+"config.json","utf8");var config=JSON.parse(file);for(i in config)self[i]=config[i]}else{for(i in window.sconfig)self[i]=window.sconfig[i]}}if(typeof exports!=="undefined")module.exports=SpaceifyConfig;function SpaceifyCore(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyNetwork:isNodeJs?function(){}:SpaceifyNetwork,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,WebSocketRpcConnection:isNodeJs?require(apiPath+"websocketrpcconnection"):WebSocketRpcConnection};var self=this;var config=new classes.SpaceifyConfig;var network=new classes.SpaceifyNetwork;var connection=null;var secureConnection=null;var useSecure=isNodeJs?true:network.isSecure();var caCrt=isNodeJs?apiPath+config.SPACEIFY_CRT_WWW:"";self.startSpacelet=function(unique_name,callback){call("startSpacelet",[unique_name],useSecure,function(err,services,id,ms){if(err)callback(err,null);else{var serviceNames=[];for(var s=0;s<services.length;s++)serviceNames.push(services[s].service_name);callback(null,{services:services,serviceNames:serviceNames},id,ms)}})};self.registerService=function(service_name,callback){call("registerService",[service_name],useSecure,callback)};self.unregisterService=function(service_name,callback){call("unregisterService",[service_name],useSecure,callback)};self.getService=function(service_name,unique_name,callback){var service=isCache()?getCache().getService(service_name,unique_name):null;if(service)callback(null,service,-1,0);else call("getService",[service_name,unique_name],useSecure,function(err,data,id,ms){if(!err&&isCache())getCache().setService(data,unique_name);callback(err,data,id,ms)})};self.getOpenServices=function(unique_names,callback){call("getOpenServices",[unique_names],useSecure,callback)};self.getManifest=function(unique_name,callback){var manifest=isCache()?getCache().getManifest(unique_name):null;if(manifest)callback(null,manifest,-1,0);else call("getManifest",[unique_name,true],useSecure,function(err,data,id,ms){if(!err&&isCache())getCache().setManifest(unique_name,data);callback(err,data,id,ms)})};self.isAdminLoggedIn=function(callback){network.POST_JSON(config.OPERATION_URL,{type:"isAdminLoggedIn"},function(err,data,id,ms){callback(err?err:null,err?false:data,id,ms)})};self.isApplicationRunning=function(unique_name,callback){call("isApplicationRunning",[unique_name],useSecure,callback)};self.getServiceRuntimeStates=function(unique_name,callback){call("getServiceRuntimeStates",[unique_name],useSecure,callback)};self.getApplicationData=function(callback){var i;call("getApplicationData",[],useSecure,function(err,data,id,ms){if(!err&&isCache()){for(i=0;i<data.spacelet.length;i++)getCache().setApplication(data.spacelet[i]);for(i=0;i<data.sandboxed.length;i++)getCache().setApplication(data.sandboxed[i])}callback(err,data,id,ms)})};self.getApplicationURL=function(unique_name,callback){var urls=isCache()?getCache().getApplicationURL(unique_name):null;if(urls)callback(null,urls,-1,0);else call("getApplicationURL",[unique_name],useSecure,function(err,data,id,ms){if(!err&&isCache())getCache().setApplicationURL(unique_name,data);callback(err,data,id,ms)})};self.setSplashAccepted=function(callback){call("setSplashAccepted",[],useSecure,callback)};var call=function(method,params,isSecure,callback){if(!isSecure&&!connection||isSecure&&!secureConnection){connect(isSecure,function(err,data,id,ms){if(!err)callRpc(method,params,isSecure,callback);else callback(err,data,id,ms)})}else callRpc(method,params,isSecure,callback)};var callRpc=function(method,params,isSecure,callback){(!isSecure?connection:secureConnection).callRpc(method,params,self,function(err,data,id,ms){callback(err,data,id,ms)})};var connect=function(isSecure,callback){var port=!isSecure?config.CORE_PORT:config.CORE_PORT_SECURE;var connection_=new classes.WebSocketRpcConnection;!isSecure?connection=connection_:secureConnection=connection_;connection_.connect({hostname:config.EDGE_HOSTNAME,port:port,isSecure:isSecure,caCrt:caCrt},callback)};var getCache=function(){return!isNodeJs&&window&&window.spaceifyCache?window.spaceifyCache:null};var isCache=function(){var type=getCache();return type=="undefined"||type==null?false:true}}if(typeof exports!=="undefined")module.exports=SpaceifyCore;function SpaceifyMessages(){var self=this;var errorc=new SpaceifyError;var config=new SpaceifyConfig;var utility=new SpaceifyUtility;var network=new SpaceifyNetwork;var messageConnection=new WebSocketConnection;var messageId;var errors=[];var warnings=[];var callerOrigin=null;var managerOrigin=null;self.MESSAGE=1;self.MESSAGE_END=2;self.MESSAGE_ERROR=3;self.MESSAGE_WARNING=4;self.MESSAGE_NOTIFY=5;self.MESSAGE_ANSWER=6;self.MESSAGE_QUESTION=7;self.MESSAGE_CONFIRM=8;self.MESSAGE_TIMED_OUT=9;self.connect=function(managerOrigin_,callerOrigin_){errors=[];warnings=[];callerOrigin=callerOrigin_;managerOrigin=managerOrigin_;if(!callerOrigin.message)return fail(errorc.makeErrorObject("sme1","Message callback must be implemented.","SpaceifyMessage::connect"));network.POST_JSON(config.OPERATION_URL,{type:"requestMessages"},function(err,messageId_){if(err)return fail(err);messageId=messageId_;messageConnection.setEventListener(self);messageConnection.connect({hostname:config.EDGE_HOSTNAME,port:config.APPMAN_MESSAGE_PORT_SECURE,isSecure:true},function(err,data){if(err)return fail(err);messageConnection.send(JSON.stringify({type:self.MESSAGE_CONFIRM,messageId:messageId}));managerOrigin.success()})})};var fail=function(err){if(callerOrigin.fail)callerOrigin.fail(err);managerOrigin.fail(err)};self.getErrors=function(){return errors};self.getWarnings=function(){return warnings};self.answer=function(answer,answerCallBackId){if(!messageConnection)return;messageConnection.send(JSON.stringify({type:self.MESSAGE_ANSWER,messageId:messageId,answer:answer,answerCallBackId:answerCallBackId}))};self.onDisconnected=function(id){};self.onMessage=function(message,connection){try{message=JSON.parse(message);if(message.type==self.MESSAGE_END)throw"";else if(message.type==self.MESSAGE_ERROR)errors.push(message.data);else if(message.type==self.MESSAGE_WARNING){warning.push(message.data);if(callerOrigin.warning)callerOrigin.warning(message.data.message,message.data.code)}else if(message.type==self.MESSAGE_NOTIFY&&callerOrigin.notify)callerOrigin.notify(message.data.message,message.data.code);else if(message.type==self.MESSAGE_QUESTION&&callerOrigin.question)callerOrigin.question(message.message,message.choices,message.source,message.answerCallBackId);else if(message.type==self.MESSAGE_TIMED_OUT&&callerOrigin.questionTimedOut)callerOrigin.questionTimedOut(message.message,message.source,message.answerCallBackId);else if(message.type==self.MESSAGE&&callerOrigin.message)callerOrigin.message(message.message)}catch(err){if(err!=="")errors.push(errorc.make(err));messageConnection.close();managerOrigin.ready(1)}}}function SpaceifyNet(){var self=this;var ordinal=0;var showLoadingInstances=0;var core=new SpaceifyCore;var config=new SpaceifyConfig;var utility=new SpaceifyUtility;var network=new SpaceifyNetwork;self.showLoading=function(show){if(show){if(showLoadingInstances==0)$("#loading").show();showLoadingInstances++}else{showLoadingInstances=Math.max(0,--showLoadingInstances);if(showLoadingInstances==0)$("#loading").hide()}};self.showError=function(msgstr){alerts(msgstr,"error")};self.showSuccess=function(msgstr){alerts(msgstr,"success")};var alerts=function(msgstr,type){var obj;if((obj=$("#alerting")).length>0)obj.remove();obj=$('<span class="edgeAlert '+type+'" id="alerting">'+msgstr+"</span>");$(document.body).append(obj);obj.css("left",($(window).width()-obj.width())/2);obj.css("visibility","visible");window.setTimeout(function(){obj.remove()},5e3)};var msgFormat=function(msg){var rmsg="",i;if(self.isArray(msg)){for(i=0;i<msg.length;i++)rmsg+=(rmsg!=""?"<br>":"")+msg[i]}else rmsg=msg;return rmsg};self.onEnterPress=function(e){var key=typeof e==null?window.event.keyCode:e.keyCode;return key==13||key==10?true:false};self.isArray=function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};self.setSplashAccepted=function(){try{core.setSplashAccepted(function(err,data){if(data&&data==true)window.location.reload(true)})}catch(err){logger.error(err,true,true,0,logger.ERROR);
}};self.loadCertificate=function(){document.getElementById("certIframe").src=network.getEdgeURL(false,false)+"/spaceify.crt";return true};self.showAdminTile=function(callback){$("#adminUtilities").empty();var evt=new CustomEvent("addTile",{detail:{type:"adminTile",container:"adminUtilities",src:network.getEdgeURL(true,false)+"/admin",callback:callback},bubbles:true,cancelable:true});document.body.dispatchEvent(evt)};self.showUserUtilities=function(callback){$("#userUtilities").empty();var evt=new CustomEvent("addTile",{detail:{type:"certificateTile",container:"userUtilities",callback:callback},bubbles:true,cancelable:true});document.body.dispatchEvent(evt)};self.showInstalledApplications=function(callback){$("#spacelet").empty();$("#sandboxed").empty();$("#native").empty();var methods=[],j;core.getApplicationData(function(err,apps){if(!apps)return typeof callback=="function"?callback():false;for(j=0;j<apps.spacelet.length;j++)methods.push({object:self,method:renderTile,params:[apps.spacelet[j],null],type:"async"});for(j=0;j<apps.sandboxed.length;j++)methods.push({object:self,method:renderTile,params:[apps.sandboxed[j],null],type:"async"});for(j=0;j<apps.native.length;j++)methods.push({object:self,method:renderTile,params:[apps.native[j],null],type:"async"});(new SpaceifySynchronous).waterFall(methods,function(){if(typeof callback=="function")callback(apps.spacelet.length,apps.sandboxed.length,apps.native.length)})})};var renderTile=function(manifest,callback){var src,evt,i;if(manifest.hasTile){core.getApplicationURL(manifest.unique_name,function(err,appURL){if(manifest.isRunning&&network.implementsWebServer(manifest))src=network.getEdgeURL(false,true)+(!network.isSecure()?appURL.port:appURL.securePort)+"/"+config.TILEFILE;else src=self.externalResourceURL(manifest.type,manifest.unique_name,config.TILEFILE);evt=new CustomEvent("addTile",{detail:{type:"appTile",container:manifest.type,manifest:manifest,src:src,callback:callback},bubbles:true,cancelable:true});document.body.dispatchEvent(evt)})}else{var src=network.getEdgeURL(false,false)+"/images/icon.png";if(manifest.images){for(i=0;i<manifest.images.length;i++){if(manifest.images[i].file.search("/^(icon.)/i"!=-1)){src=self.externalResourceURL(manifest.type,manifest.unique_name,(manifest.images[i].directory?manifest.images[i].directory+"/":"")+manifest.images[i].file);break}}}evt=new CustomEvent("addTile",{detail:{type:"tile",container:manifest.type,manifest:manifest,src:src,callback:callback},bubbles:true,cancelable:true});document.body.dispatchEvent(evt)}};self.externalResourceURL=function(type,unique_name,file){return network.getEdgeURL(false,false)+"/"+type+"/"+unique_name+"/get/"+file}}function SpaceifyNetwork(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility};var self=this;var config=new classes.SpaceifyConfig;var utility=new classes.SpaceifyUtility;self.getEdgeURL=function(forceSecure,withPort){return(forceSecure?"https:":location.protocol)+"//"+config.EDGE_HOSTNAME+(withPort?":":"")};self.getPort=function(port,securePort,isSecure){return!self.isSecure()&&!isSecure?port:securePort};self.isSecure=function(){return location.protocol=="http:"?false:true};self.getProtocol=function(withScheme){return(location.protocol=="http:"?"http":"https")+(withScheme?"://":"")};self.parseQuery=function(url){var query={},parts,pairs;var regx=new RegExp("=","i");if((parts=url.split("?")).length!=2)return query;pairs=parts[1].split("&");for(var i=0;i<pairs.length;i++){if(regx.exec(pairs[i]))query[RegExp.leftContext]=RegExp.rightContext;else query[pairs[i]]=null}return query};self.remakeQueryString=function(query,exclude,include,path){var search="",i;for(i in query){if(!exclude.indexOf(i))search+=(search!=""?"&":"")+i+(query[i]?"="+query[i]:"")}for(i in include)search+=(search!=""?"&":"")+i+"="+include[i];return Object.keys(query).length>0?(path?path:"")+"?"+search:""};self.parseURL=function(url){var o={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},m=o.parser[o.strictMode?"strict":"loose"].exec(url),uri={},i=14;while(i--)uri[o.key[i]]=m[i]||"";uri[o.q.name]={};uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){if($1)uri[o.q.name][$1]=$2});return uri};self.implementsWebServer=function(manifest){return manifest.implements&&manifest.implements.indexOf(config.WEB_SERVER)!=-1?true:false};self.GET=function(url,callback,responseType){var ms=Date.now();var id=utility.randomString(16,true);var xmlhttp=createXMLHTTP();xmlhttp.onreadystatechange=function(){onReadyState(xmlhttp,id,ms,callback)};xmlhttp.open("GET",url,true);xmlhttp.responseType=responseType?responseType:"";xmlhttp.send()};self.POST_FORM=function(url,post,responseType,callback){var boundary="---------------------------"+Date.now().toString(16);var content="";for(var i=0;i<post.length;i++){content+="--"+boundary+"\r\n";content+=post[i].content;content+="\r\n\r\n"+post[i].data+"\r\n"}content+="\r\n--"+boundary+"--";var ms=Date.now();var id=utility.randomString(16,true);var xmlhttp=createXMLHTTP();xmlhttp.onreadystatechange=function(){onReadyState(xmlhttp,id,ms,callback)};xmlhttp.open("POST",url,true);xmlhttp.responseType=responseType?responseType:"text/plain";xmlhttp.setRequestHeader("Content-Type","multipart/form-data; boundary="+boundary);xmlhttp.setRequestHeader("Content-Length",content.length);xmlhttp.send(content)};self.POST_JSON=function(url,jsonData,callback){try{var content="Content-Disposition: form-data; name=data;\r\nContent-Type: application/json; charset=utf-8";self.POST_FORM(config.OPERATION_URL,[{content:content,data:JSON.stringify(jsonData)}],"application/json",function(err,response,id,ms){var result=JSON.parse(response.replace(/&quot;/g,'"'));var error=null;if(result.err)error=result.err;else if(result.error)error=result.error;callback(error,result.data,id,ms)})}catch(err){callback(err,null)}};var createXMLHTTP=function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")};var onReadyState=function(xmlhttp,id,ms,callback){if(xmlhttp.readyState==4)callback(xmlhttp.status!=200?xmlhttp.status:null,xmlhttp.status==200?xmlhttp.response:null,id,Date.now()-ms)}}if(typeof exports!=="undefined")module.exports=SpaceifyNetwork;function SpaceifyRequest(){var self=this;var addTags=[];var core=new SpaceifyCore;var network=new SpaceifyNetwork;self.head=function(wnd){return wnd.document.getElementsByTagName("head")[0]||wnd.document.documentElement};self.loadImage=function(src,id,context,unique_name,callback){if(typeof callback=="function")loadResources([{src:src,id:id,context:context,unique_name:unique_name}],function(){callback()});else addTags.push({src:src,id:id,context:context,unique_name:unique_name});return self};self.loadCSS=function(href,id,context,unique_name,callback){if(typeof callback=="function")loadResources([{href:href,id:id,context:context,unique_name:unique_name}],function(){callback()});else addTags.push({href:href,id:id,context:context,unique_name:unique_name});return self};self.loadJS=function(src,id,context,unique_name){if(typeof callback=="function")loadResources([{src:src,id:id,context:context,unique_name:unique_name}],function(){callback()});else addTags.push({src:src,id:id,context:context,unique_name:unique_name});return self};self.addImage=function(src,id,context,unique_name){addTags.push({createtag:"img",src:src,context:context,unique_name:unique_name,properties:{id:id}});return self};self.addCSS=function(href,id,context,media,unique_name){addTags.push({createtag:"link",href:href,context:context,unique_name:unique_name,properties:{id:id,media:media,type:"text/css",rel:"stylesheet"}});return self};self.addJS=function(src,id,context,unique_name){addTags.push({createtag:"script",src:src,context:context,unique_name:unique_name,properties:{id:id,type:"text/javascript"}});return self};self.addjQuery=function(){if(typeof jQuery==="undefined")addTags.push({createtag:"script",src:"js/jquery.min.js",context:self.head(window),unique_name:"",properties:{type:"text/javascript"}});return self};self.addjQueryTag=function(callback){if(typeof jQuery=="undefined"){var script=document.createElement("script");script.type="text/javascript";script.onreadystatechange=function(){if(this.readyState==4)return callback()};script.onload=function(){return callback()};script.src=network.getEdgeURL(false,false)+"/js/jquery.min.js";var head=document.getElementsByTagName("head")[0]||document.documentElement;head.parentNode.insertBefore(script,head.nextSibling)}else callback()};self.load=function(callback){loadResources(addTags,function(){if(callback=="function");callback()})};var loadResources=function(tags,callback){var tag=null;if(tags.length==0&&typeof callback=="function")return callback();else if(tags.length==0)return;var nextTag=tags.shift();if(nextTag.createtag){tag=document.createElement(nextTag.createtag);for(var i in nextTag.properties)tag.setAttribute(i,nextTag.properties[i]);nextTag.context.appendChild(tag)}else if(nextTag.id)tag=nextTag.context.getElementById(nextTag.id);if(!tag)loadResources(tags,callback);else{tag.onload=function(){tag.onload=null;loadResources(tags,callback)};self.makeURL(nextTag.src?nextTag.src:nextTag.href,nextTag.unique_name,function(err,data){network.GET(data,function(err,data){if(!err){var doc=tag.ownerDocument;var win=doc.defaultView||doc.parentWindow;tag.setAttribute(nextTag.src?"src":"href",win.URL.createObjectURL(data))}},"blob")})}};self.makeURL=function(src,unique_name,callback){if(!unique_name)return returnURL(src,null,callback);core.getApplicationURL(unique_name,function(err,data){return returnURL(src,data,callback)})};var returnURL=function(src,urls,callback){src=(src.search(/^\//)!=-1?"":"/")+src;if(!urls||urls&&!urls.type)callback(null,network.getEdgeURL(false,false)+src);else{var objQuery=network.parseQuery(src,false);var appUrl=network.getProtocol(true)+(!network.isSecure()?urls.url:urls.secureUrl)+src+network.remakeQueryString(objQuery,[],{app:urls.unique_name,type:urls.type},null);callback(null,appUrl)}}}function SpaceifyService(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Service:isNodeJs?require(apiPath+"service"):Service,SpaceifyCore:isNodeJs?require(apiPath+"spaceifycore"):SpaceifyCore,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,SpaceifyNetwork:isNodeJs?require(apiPath+"spaceifynetwork"):SpaceifyNetwork,WebSocketRpcServer:isNodeJs?require(apiPath+"websocketrpcserver"):null,WebSocketRpcConnection:isNodeJs?require(apiPath+"websocketrpcconnection"):WebSocketRpcConnection};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var core=new classes.SpaceifyCore;var config=new classes.SpaceifyConfig;var network=new classes.SpaceifyNetwork;var required={};var requiredSecure={};var provided={};var providedSecure={};var keepServerUp=true;var keepConnectionUp=true;var keepConnectionUpTimerIds={};var caCrt=apiPath+config.SPACEIFY_CRT_WWW;var key=config.APPLICATION_TLS_PATH+config.SERVER_KEY;var crt=config.APPLICATION_TLS_PATH+config.SERVER_CRT;self.connect=function(service_name,callback){if(!required[service_name]){required[service_name]=new classes.Service(service_name,false,new classes.WebSocketRpcConnection);required[service_name].setConnectionListener(connectionListener);required[service_name].setDisconnectionListener(disconnectionListener)}if(!requiredSecure[service_name]){requiredSecure[service_name]=new classes.Service(service_name,false,new classes.WebSocketRpcConnection);requiredSecure[service_name].setConnectionListener(connectionListener);requiredSecure[service_name].setDisconnectionListener(disconnectionListener)}core.getService(service_name,"",function(err,service){if(!service||err){if(!required[service_name].getIsOpen())disconnectionListener(-1,service_name,false);if(!requiredSecure[service_name].getIsOpen())disconnectionListener(-1,service_name,true);return callback(null,true)}connect(required[service.service_name],service.port,false,function(){var hasSecure=isNodeJs?true:network.isSecure();if(hasSecure){connect(requiredSecure[service.service_name],service.securePort,true,function(){callback(null,{insecure:required[service_name],secure:requiredSecure[service_name]})})}else callback(null,{insecure:required[service_name],secure:requiredSecure[service_name]})})})};var connect=function(service,port,isSecure,callback){if(service.getIsOpen())return callback();service.getConnection().connect({hostname:config.EDGE_HOSTNAME,port:port,isSecure:isSecure,caCrt:caCrt,debug:true},callback)};self.disconnect=function(service_names,callback){var keys;if(!service_names)keys=Object.keys(required);else if(service_name.constructor!==Array)keys=[service_names];for(var i=0;i<keys.length;i++){if(keys[i]in required)required[keys[i]].getConnection().close();if(keys[i]in requiredSecure)requiredSecure[keys[i]].getConnection().close()}};var connectionListener=function(id,service_name,isSecure){};var disconnectionListener=function(id,service_name,isSecure){if(!keepConnectionUp)return;var timerIdName=service_name+(!isSecure?"F":"T");if(timerIdName in keepConnectionUpTimerIds)return;var service=!isSecure?required[service_name]:requiredSecure[service_name];keepConnectionUpTimerIds[timerIdName]=setTimeout(waitConnectionAttempt,config.RECONNECT_WAIT,id,service_name,isSecure,timerIdName,service)};var waitConnectionAttempt=function(id,service_name,isSecure,timerIdName,service){core.getService(service_name,"",function(err,serviceObj){delete keepConnectionUpTimerIds[timerIdName];if(serviceObj)connect(service,!isSecure?serviceObj.port:serviceObj.securePort,isSecure,function(){});else disconnectionListener(id,service_name,isSecure)})};self.getRequiredService=function(service_name){return required[service_name]?required[service_name]:null};self.getRequiredServiceSecure=function(service_name){return requiredSecure[service_name]?requiredSecure[service_name]:null};self.keepConnectionUp=function(val){keepConnectionUp=typeof val=="boolean"?val:false};self.listen=fibrous(function(service_name,port,securePort){if(!provided[service_name])provided[service_name]=new classes.Service(service_name,true,new classes.WebSocketRpcServer);if(!providedSecure[service_name])providedSecure[service_name]=new classes.Service(service_name,true,new classes.WebSocketRpcServer);listen.sync(provided[service_name],port,false);listen.sync(providedSecure[service_name],securePort,true);core.sync.registerService(service_name)});var listen=fibrous(function(service,port,isSecure){if(service.getIsOpen())return;service.getServer().listen({hostname:null,port:port,isSecure:isSecure,key:key,crt:crt,caCrt:caCrt,keepUp:keepServerUp,debug:true})});self.close=function(service_name){var keys;if(!service_names)keys=Object.keys(required);else if(service_name.constructor!==Array)keys=[service_names];for(var i=0;i<keys.length;i++){if(keys[i]in provided)provided[keys[i]].getServer().close();if(keys[i]in providedSecure)providedSecure[keys[i]].getServer().close()}};self.getProvidedService=function(service_name){return provided[service_name]?provided[service_name]:null};self.getProvidedServiceSecure=function(service_name){return providedSecure[service_name]?providedSecure[service_name]:null};self.keepServerUp=function(val){keepServerUp=typeof val=="boolean"?val:false}}if(typeof exports!=="undefined")module.exports=SpaceifyService;function SpaceifyUtility(){if(typeof exports!=="undefined"){global.os=require("os");global.fs=require("fs");global.path=require("path");global.mkdirp=require("mkdirp");global.AdmZip=require("adm-zip");global.fibrous=require("fibrous");global.request=require("request");global.spawn=require("child_process").spawn}var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,Language:isNodeJs?require(apiPath+"language"):{},SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var logger=new classes.Logger;var language=classes.Language;var config=new classes.SpaceifyConfig;self.loadRemoteFile=fibrous(function(fileUrl){var result;try{result=request.sync.get(fileUrl,{encoding:null,rejectUnauthorized:false,agent:false})}catch(err){throw language.E_FAILED_TO_INITIATE_HTTP_GET.pre("SpaceifyUtility::loadRemoteFile",err)}if(result.statusCode!=200)throw language.E_FAILED_TO_LOAD_REMOTE_FILE.preFmt("SpaceifyUtility::loadRemoteFile",{"~file":fileUrl,"~code":result.statusCode});return result});self.loadRemoteFileToLocalFile=fibrous(function(fileUrl,targetDir,targetFile,throws){try{var result=self.sync.loadRemoteFile(fileUrl);if(result.statusCode==200)self.sync.writeFile(targetDir,targetFile,result.body);return true}catch(err){if(throws)throw language.E_LOAD_REMOTE_FILE_TO_LOCAL_FILE.pre("SpaceifyUtility::loadRemoteFileToLocalFile",err)}return false});self.isLocal=fibrous(function(path,type){try{var stats=fs.sync.stat(path);if(stats&&type=="file"&&stats.isFile())return true;else if(stats&&type=="directory"&&stats.isDirectory())return true}catch(err){}return false});self.getPathType=fibrous(function(path){try{var stats=fs.sync.stat(path);if(stats&&stats.isFile())return"file";else if(stats&&stats.isDirectory())return"directory"}catch(err){}return"undefined"});self.deleteDirectory=fibrous(function(source,throws){try{var stats=fs.sync.stat(source);if(typeof stats!="undefined"&&stats.isDirectory()){fs.sync.readdir(source).forEach(function(file,index){var curPath=source+"/"+file;if(fs.sync.stat(curPath).isDirectory())self.sync.deleteDirectory(curPath,throws);else fs.sync.unlink(curPath)});fs.sync.rmdir(source)}}catch(err){if(throws)throw language.E_DELETE_DIRECTORY.pre("SpaceifyUtility::deleteDirectory",err)}});self.copyDirectory=fibrous(function(source,target,throws,excludeDirectory){try{source+=source.search(/\/$/)!=-1?"":"/";target+=target.search(/\/$/)!=-1?"":"/";var stats=fs.sync.stat(source);if(typeof stats=="undefined"||!stats.isDirectory()||excludeDirectory.indexOf(source)!=-1)return;var mode=parseInt("0"+(stats.mode&511).toString(8),8);mkdirp.sync(target,mode);fs.sync.readdir(source).forEach(function(file,index){var sourcePath=source+file;var targetPath=target+file;stats=fs.sync.stat(sourcePath);if(stats.isDirectory()){self.sync.copyDirectory(sourcePath+"/",targetPath+"/",throws,excludeDirectory)}else{mode=parseInt("0"+(stats.mode&511).toString(8),8);var readStream=fs.createReadStream(sourcePath,{autoClose:true});var writeStream=fs.createWriteStream(targetPath,{mode:mode});readStream.pipe(writeStream)}})}catch(err){if(throws)throw language.E_COPY_DIRECTORY.pre("SpaceifyUtility::copyDirectory",err)}});self.moveDirectory=fibrous(function(source,target,throws){try{self.sync.copyDirectory(source,target,true,[]);self.sync.deleteDirectory(source,true)}catch(err){if(throws)throw language.E_MOVE_DIRECTORY.pre("SpaceifyUtility::moveDirectory",err)}});self.deleteFile=fibrous(function(source,throws){try{var stats=fs.sync.stat(source);if(typeof stats!="undefined"&&!stats.isDirectory())fs.sync.unlink(source)}catch(err){if(throws)throw language.E_DELETE_FILE.pre("SpaceifyUtility::deleteFile",err)}});self.copyFile=fibrous(function(sourceFile,targetFile,throws){try{var stats=fs.sync.stat(sourceFile);if(typeof stats!="undefined"&&!stats.isDirectory()){var mode=parseInt("0"+(stats.mode&511).toString(8),8);var readStream=fs.createReadStream(sourceFile,{autoClose:true});var writeStream=fs.createWriteStream(targetFile,{mode:mode});readStream.pipe(writeStream)}}catch(err){if(throws)throw language.E_COPY_FILE.pre("SpaceifyUtility::copyFile",err)}});self.moveFile=fibrous(function(sourceFile,targetFile,throws){try{self.sync.copyFile(sourceFile,targetFile,true);self.sync.deleteFile(sourceFile,true)}catch(err){if(throws)throw language.E_MOVE_FILEE.pre("SpaceifyUtility::moveFile",err)}});self.zipDirectory=fibrous(function(source,zipfile){source=source+(source!=""&&source.search(/\/$/)==-1?"/":"");try{self.execute.sync("zip",["-r","-q",zipfile,".","-i","*"],{cwd:source},null)}catch(err){logger.log(err,true,true,logger.ERROR)}});self.getFileFromZip=function(zipFilename,filename,extractPath,deleteAfter){var regex=new RegExp(filename+"$","i");var zip=new AdmZip(zipFilename);var zipEntries=zip.getEntries();for(var ze in zipEntries){if(zipEntries[ze].entryName.search(regex)!=-1){if(extractPath)zip.extractAllTo(extractPath,true);return zip.readAsText(zipEntries[ze].entryName)}}if(deleteAfter)self.sync.deleteFile(zipFilename);return null};self.unZip=function(zipFilename,extractPath,deleteAfter){var zip=new AdmZip(zipFilename);zip.extractAllTo(extractPath,true);if(deleteAfter)self.sync.deleteFile(zipFilename);return true};self.writeFile=fibrous(function(targetDir,targetFile,data){mkdirp.sync(targetDir);fs.sync.writeFile(targetDir+targetFile,data)});self.preparePath=function(directory){return directory+(!directory.match(/^$/)&&!directory.match(/\/$/)?"/":"")};self.postForm=fibrous(function(url,form){var result;try{result=request.sync.post(url,form)}catch(err){throw language.E_FAILED_TO_INITIATE_HTTP_POST.pre("SpaceifyUtility::postForm",err)}if(result.statusCode!=200)throw language.E_FAILED_TO_POST_FORM.preFmt("SpaceifyUtility::postForm",{"~url":url,"~code":result.statusCode});return result});self.remakeQueryString=function(objQuery,exclude,include,path){var query="",i;for(i in objQuery){if(exclude.indexOf(i)==-1)query+=(query!=""?"&":"")+i+(objQuery[i]?"="+objQuery[i]:"")}for(i in include)query+=(query!=""?"&":"")+i+(include[i]?"="+include[i]:"");return Object.keys(objQuery).length>0?(path?path:"")+"?"+query:""};self.postPublish=function(applicationPackage,username,password,release_name,callback){logger.force(language.PACKAGE_POSTING);request({url:config.REGISTRY_PUBLISH_URL,headers:{"content-type":"multipart/form-data"},method:"POST",multipart:[{"Content-Disposition":'form-data; name="username"',body:username},{"Content-Disposition":'form-data; name="password"',body:password},{"Content-Disposition":'form-data; name="release"',body:release_name},{"Content-Disposition":'form-data; name="package"; filename="'+config.PUBLISH_ZIP+'"',"Content-Type":"application/zip",body:fs.readFileSync(applicationPackage)}]},function(err,result,body){callback(err?err:null,err?null:result.statusCode!=200?result.statusCode:body)})};self.postRegister=function(edge_uuid,edge_password,callback){logger.force(language.POSTING_REGISTRATION);request({url:config.EDGE_REGISTRATION_URL,headers:{"content-type":"multipart/form-data"},method:"POST",multipart:[{"Content-Disposition":'form-data; name="eid"',body:edge_uuid},{"Content-Disposition":'form-data; name="epw"',body:edge_password}]},function(err,result,body){callback(err?err:null,err?null:result.statusCode!=200?parseInt(result.statusCode):body)})};var isMAC=function(MAC){return MAC.match(new RegExp(config.MAC_REGX,"i"))};self.parseURLFromURLObject=function(urlObj,host,protocol,port){urlObj.hostname=host+(port?":"+port:"");urlObj.protocol=protocol;return urlObj.format(urlObj)};self.parseMultiPartData=function(contentType,body,throws){var boundary,partBoundary,endBoundary,dataLine,phase,contentTypeData={},bodyData,bodyParts={};try{self.parseMultipartLine(contentType,contentTypeData);if(!(boundary=contentTypeData["boundary"]))throw"";partBoundary="--"+boundary;endBoundary="--"+boundary+"--";body=body.split("\r\n");body.shift();while(body.length>0){phase=0;bodyData={body:""};dataLine=body.shift();while(body.length>0&&dataLine!=partBoundary&&dataLine!=endBoundary){if(dataLine=="")phase++;else if(phase==0)self.parseMultipartLine(dataLine,bodyData);else bodyData.body+=dataLine;dataLine=body.shift()}if(bodyData.name)bodyParts[bodyData.name]=bodyData}}catch(err){if(throws)throw err}return bodyParts};self.parseMultipartLine=function(line,keyvalues){var parts=line.split(";");for(var i=0;i<parts.length;i++){if(!parts[i])continue;var matched=parts[i].match(/[:=]/);if(!matched)keyvalues[parts[i].trim()]="";else{var key=parts[i].substr(0,matched.index);var value=parts[i].substr(matched.index+1);keyvalues[key.trim().toLowerCase()]=value.trim()}}};self.loadJSON=fibrous(function(file,bParse,throws){var manifest=null;try{manifest=fs.sync.readFile(file,{encoding:"utf8"});if(bParse)manifest=self.parseJSON(manifest,throws)}catch(err){manifest=null;if(throws)throw language.E_LOAD_JSON.pre("SpaceifyUtility::loadJSON",err)}return manifest});self.saveJSON=fibrous(function(file,json,throws){var success=false;try{var jsondata=JSON.stringify(json,null,2);fs.sync.writeFile(file,jsondata,{encoding:"utf8"});success=true}catch(err){if(throws)throw language.E_SAVE_JSON.pre("SpaceifyUtility::saveJSON",err)}return success});self.parseJSON=function(str,throws){var json;try{json=JSON.parse(str)}catch(err){if(throws)throw isNodeJs?language.E_JSON_PARSE_FAILED.pre("SpaceifyUtility::parseJSON",err):self.makeErrorObject("JSON","Failed to parse JSON.","SpaceifyUtility::parseJSON")}return json};self.replaces=function(str,strs){for(var s=strs.length-1;s>=0;s--){var regx=new RegExp("%"+s,"g");str=str.replace(regx,typeof strs[s]=="undefined"?"?":strs[s])}return str};self.replace=function(str,strs,replaceWith){var r=replaceWith?replaceWith:"",i;for(i in strs){if(typeof strs[i]=="undefined")continue;str=str.replace(i,strs[i])}str=str.replace(/\s~[a-zA-Z0-9]*\s/g," "+r+" ");str=str.replace(/~[a-zA-Z0-9]+\s/g," "+r+" ");str=str.replace(/\s~[a-zA-Z0-9]+/g,r);str=str.replace(/~[a-zA-Z0-9]+/g,r);return str};self.execute=function(command,args,options,spmMessage,callback){var bExited=false;var stdout="";var stderr="";var spawned=spawn(command,args,options);spawned.stdout.on("data",function(data){if(spmMessage)spmMessage.sync(data,true);else logger.force(data,true);stdout+=data});spawned.stderr.on("data",function(data){if(spmMessage)spmMessage.sync(data,true);else logger.force(data,true);stderr+=data});spawned.on("error",function(err){if(!bExited){callback(err,null);bExited=true}});spawned.on("close",function(code){if(!bExited){callback(null,{code:code,signal:null,stdout:stdout,stderr:stderr});bExited=true}});spawned.on("exit",function(code,signal){if(!bExited){callback(null,{code:code,signal:signal,stdout:stdout,stderr:stderr});bExited=true}})};self.ucfirst=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};self.randomString=function(length,useAlpha){var chars="",i;if(useAlpha)chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";else chars="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!�$#%&/(){}[]<>|��=+?*,.;:-_";var result="";for(i=length;i>0;--i)result+=chars[Math.round(Math.random()*(chars.length-1))];return result};self.generateRandomConnectionId=function(connections){var ret;while(true){ret=Math.floor(Math.random()*4294967296);if(!connections.hasOwnProperty(ret))break}return ret};self.bytesToHexString=function(bytes){for(var hex=[],i=0;i<bytes.length;i++){hex.push((bytes[i]>>>4).toString(16));hex.push((bytes[i]&15).toString(16))}return hex.join("")};self.getLocalDateTime=function(){var date;date=new Date;date=date.getFullYear()+"-"+("00"+(date.getMonth()+1)).slice(-2)+"-"+("00"+date.getDate()).slice(-2)+" "+("00"+date.getHours()).slice(-2)+":"+("00"+date.getMinutes()).slice(-2)+":"+("00"+date.getSeconds()).slice(-2);return date};self.isObjectEmpty=function(obj){return typeof obj!="object"?true:Object.keys(obj).length==0?true:false};self.assoc=function(_array,_key,_value){_key in _array?_array[_key]=[_value]:_array[key].push(_value);return _array};self.toBuffer=function(data){if(data instanceof Buffer)return data;else if(data instanceof Array||data instanceof Object)return new Buffer(JSON.stringify(data),"utf8");else if(typeof data=="string")return new Buffer(data,"utf8");else return new Buffer(data.toString(),"utf8")};self.setCookie=function(cname,cvalue,expiration_sec){var expires="";if(expiration_sec){var dn=Date.now()+expiration_sec*1e3;var dc=new Date(dn);expires="expires="+dc.toGMTString()}document.cookie=cname+"="+cvalue+(expires!=""?"; "+expires:"")};self.getCookie=function(cname){var name=cname+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1);if(c.indexOf(name)!=-1)return c.substring(name.length,c.length)}return""};self.deleteCookie=function(cname){document.cookie=cname+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"}}if(typeof exports!=="undefined")module.exports=SpaceifyUtility;function Spacelet(){var self=this;var core=new SpaceifyCore;var spaceifyService=new SpaceifyService;self.start=function(application,unique_name,callback){try{core.startSpacelet(unique_name,function(err,serviceobj){if(err)throw err;else{for(var i=0;i<serviceobj.serviceNames.length;i++){spaceifyService.connect(serviceobj.serviceNames[i],i+1!=serviceobj.serviceNames.length?null:function(err,data){if(typeof application=="function")application(null,true);else if(application&&application.start)application.start()})}}})}catch(err){if(typeof application=="function")application(err,false);else if(application&&application.fail)application.fail(err)}};self.getRequiredService=function(service_name){return spaceifyService.getRequiredService(service_name)};self.getRequiredServiceSecure=function(service_name){return spaceifyService.getRequiredServiceSecure(service_name)}}function SpaceifyApplication(){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={Logger:isNodeJs?require(apiPath+"logger"):Logger,WebServer:isNodeJs?require(apiPath+"webserver"):function(){},SpaceifyCore:isNodeJs?require(apiPath+"spaceifycore"):SpaceifyCore,SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility,SpaceifyService:isNodeJs?require(apiPath+"spaceifyservice"):SpaceifyService};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var logger=new classes.Logger;var httpServer=new classes.WebServer;var httpsServer=new classes.WebServer;var config=new classes.SpaceifyConfig;var utility=new classes.SpaceifyUtility;var spaceifyCore=new classes.SpaceifyCore;var spaceifyService=new classes.SpaceifyService;var wwwPath=config.APPLICATION_WWW_PATH;var manifestPath=config.APPLICATION_PATH||"";var caCrt=config.API_WWW_PATH+config.SPACEIFY_CRT;var key=config.APPLICATION_TLS_PATH+config.SERVER_KEY;var crt=config.APPLICATION_TLS_PATH+config.SERVER_CRT;var manifest=null;var HTTP_PORT=isRealSpaceify?80:6080;var HTTPS_PORT=isRealSpaceify?443:6443;self.start=function(){if(isNodeJs)start.apply(self,arguments);else self.connect.apply(self,arguments)};var start=function(application,options){fibrous.run(function(){var service_name;try{manifest=utility.sync.loadJSON(manifestPath+config.MANIFEST,true,true);if(manifest.provides_services){
var services=manifest.provides_services;for(var i=0;i<services.length;i++)spaceifyService.sync.listen(services[i].service_name,config.FIRST_SERVICE_PORT+i,config.FIRST_SERVICE_PORT_SECURE+i)}if(manifest.requires_services)createRequiredServices.sync(manifest.requires_services);if(options&&options.webservers){var opts={hostname:config.ALL_IPV4_LOCAL,key:key,crt:crt,caCrt:caCrt,wwwPath:wwwPath,indexFile:config.INDEX_HTML,serverName:manifest.name+" Server"};if(options.webservers.http&&options.webservers.http===true&&!httpServer.getIsOpen()){opts.isSecure=false;opts.port=HTTP_PORT;httpServer.connect.sync(opts)}if(options.webservers.https&&options.webservers.https===true&&!httpsServer.getIsOpen()){opts.isSecure=true;opts.port=HTTPS_PORT;httpsServer.connect.sync(opts)}}if(application.start)application.start();console.log(config.APPLICATION_INITIALIZED,"-",manifest.unique_name)}catch(err){if(application.fail)application.fail(err);initFail.sync(err)}},function(err,data){})};self.connect=function(application,unique_names,options){try{if(unique_names.constructor!==Array)unique_names=[unique_names];spaceifyCore.getOpenServices(unique_names,function(err,services){if(err)throw err;else connectServices(application,services)})}catch(err){if(typeof application=="function")application(err,false);else if(application&&application.fail)application.fail(err)}};var connectServices=function(application,services){var service=services.shift();if(typeof service==="undefined"){if(typeof application=="function")application(null,true);else if(application&&application.start)application.start();return}spaceifyService.connect(service.service_name,function(err,data){connectServices(application,services)})};var initFail=fibrous(function(err){logger.error([";;",err,"::"],true,true,logger.ERROR);console.log(manifest.unique_name+config.APPLICATION_UNINITIALIZED);stop.sync()});var stop=fibrous(function(){httpServer.sync.close();httpsServer.sync.close();spaceifyService.disconnect();spaceifyService.close()});var createRequiredServices=function(services,callback){for(var i=0;i<services.length;i++)spaceifyService.connect(services[i].service_name,i+1!=services.length?null:callback)};self.getOwnUrl=function(isSecure){if(!isNodeJs)return null;var httpPort=isRealSpaceify?process.env.PORT_80:HTTP_PORT;var httpsPort=isRealSpaceify?process.env.PORT_443:HTTPS_PORT;var port=!isSecure?httpPort:httpsPort;var ownUrl=(!isSecure?"http://":"https://")+config.EDGE_HOSTNAME+":"+port;return ownUrl};self.getManifest=function(){return manifest};self.getRequiredService=function(service_name){return spaceifyService.getRequiredService(service_name)};self.getRequiredServiceSecure=function(service_name){return spaceifyService.getRequiredServiceSecure(service_name)};self.getProvidedService=function(service_name){return spaceifyService.getProvidedService(service_name)};self.getProvidedServiceSecure=function(service_name){return spaceifyService.getProvidedServiceSecure(service_name)}}if(typeof exports!=="undefined")module.exports=new SpaceifyApplication;function SpaceifyError(errObj){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig};var self=this;var config=new classes.SpaceifyConfig;self.path=errObj&&errObj.path?errObj.path:"";self.code=errObj&&errObj.code?errObj.code:"";self.message=errObj&&errObj.message?errObj.message:"";var CODE_SEPARATOR=", ";var PATH_SEPARATOR=", ";var MESSAGE_SEPARATOR=" ";self.set=function(err){self.path=err.path||"";self.code=err.code||"";self.message=err.message||""};self.getAsObject=function(){return{code:self.code,codes:[self.code],message:self.message,messages:[self.message],path:self.path,paths:[self.path]}};self.getMessage=function(){return self.message};self.getCode=function(){return self.code};self.getPath=function(){return self.path};self.pre=function(path){self.path=path;var args=Array.prototype.slice.call(arguments);args[0]=self.getAsObject();return self.make.apply(this,args)};self.preFmt=function(path,params){self.path=path;return self.makeFmt(self.getAsObject(),params)};self.make=function(){var i;var path="",paths=[];var code="",codes=[];var message="",messages=[];for(i=0;i<arguments.length;i++){var aobj=arguments[i];if(aobj.messages){paths=paths.concat(aobj.paths);codes=codes.concat(aobj.codes);messages=messages.concat(aobj.messages)}else{paths.push(aobj.path?aobj.path:"");codes.push(aobj.code?aobj.code:"");messages.push(aobj.message?aobj.message:aobj.toString())}}for(i=0;i<messages.length;i++){if(codes[i])code+=(code!=""?CODE_SEPARATOR:"")+codes[i];if(paths[i])path+=(path!=""?PATH_SEPARATOR:"")+paths[i];message+=(message!=""?MESSAGE_SEPARATOR:"")+messages[i]}return{code:code,message:message,path:path,codes:codes,paths:paths,messages:messages}};self.makeFmt=function(err,params){err.message=self.replace(err.message,params);if(err.messages&&err.messages.length>0)err.messages[0]=err.message;return self.make(err)};self.makeErrorObject=function(code,message,path){var code_=typeof code!="undefined"?code:"";var path_=typeof path!="undefined"?path:"";var message_=typeof message!="undefined"?message:"";return{code:code_,codes:[code_],message:message_,messages:[message_],path:path_,paths:[path_]}};self.errorFromObject=function(eobj){if(typeof eobj=="string")eobj=JSON.parse(eobj);return self.make(self.makeErrorObject(eobj.code,eobj.message,eobj.path))};self.typeToErrorObject=function(err){if(!err)err=self.makeErrorObject("###","###","###");else if(typeof err=="string")err=self.makeErrorObject("",err,"");else if(!err.codes&&!err.messages&&!err.paths)err=self.make(err);return err};self.errorToString=function(err,printPath,printCode){var errstr="",code="",path="";if(typeof err=="string")errstr+=err;else if(err.message&&!err.messages)errstr+=err.message;else if(err.pop){while(err.length>0)errstr+=(errstr!=""?MESSAGE_SEPARATOR:"")+self.errorToString(err.shift())}else if(err.messages){for(var i=0;i<err.messages.length;i++){code=printCode&&err.codes[i]?err.codes[i]:null;path=printPath&&err.paths[i]?err.paths[i]:null;errstr=errstr!=""?", ":"";errstr+=path?path:"";errstr+=code?(path?" - ":"")+code:"";errstr+=(code||path?" ":"")+err.messages[i]}}return errstr};self.replace=function(str,strs,replaceWith){var rw=replaceWith?replaceWith:"";for(var i in strs){if(typeof strs[i]=="undefined")continue;str=str.replace(i,strs[i])}str=str.replace(/\s~[a-zA-Z0-9]*\s/g," "+rw+" ");str=str.replace(/~[a-zA-Z0-9]*\s/g," "+rw+" ");str=str.replace(/\s~[a-zA-Z0-9]*/g,rw);str=str.replace(/~[a-zA-Z0-9]+/g,rw);return str}}if(typeof exports!=="undefined")module.exports=SpaceifyError;function Service(service_name,isServer,connection){var isNodeJs=typeof exports!=="undefined"?true:false;var isRealSpaceify=typeof process!=="undefined"?process.env.IS_REAL_SPACEIFY:false;var apiPath=isNodeJs&&isRealSpaceify?"/api/":"/var/lib/spaceify/code/";var classes={SpaceifyConfig:isNodeJs?require(apiPath+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:isNodeJs?require(apiPath+"spaceifyutility"):SpaceifyUtility};var fibrous=isNodeJs?require("fibrous"):function(fn){return fn};var self=this;var config=new classes.SpaceifyConfig;var utility=new classes.SpaceifyUtility;var serverUpListener=null;var serverDownListener=null;var connectionListeners=[];var disconnectionListeners=[];self.REQUIRED=0;self.PROVIDED=1;var listenConnection=function(id){for(var i=0;i<connectionListeners.length;i++)connectionListeners[i](id,service_name,self.getIsSecure())};var listenDisconnection=function(id){for(var i=0;i<disconnectionListeners.length;i++)disconnectionListeners[i](id,service_name,self.getIsSecure())};var listenServerUp=function(id){if(serverUpListener)serverUpListener(id,service_name,self.getIsSecure())};var listenServerDown=function(id){if(serverDownListener)listenServerDown(id,service_name,self.getIsSecure())};self.setConnectionListener=function(listener){if(typeof listener=="function")connectionListeners.push(listener)};self.setDisconnectionListener=function(listener){if(typeof listener=="function")disconnectionListeners.push(listener)};self.setServerUpListener=function(listener){serverUpListener=typeof listener=="function"?listener:null};self.setServerDownListener=function(listener){serverDownListener=typeof listener=="function"?listener:null};self.getPort=function(){return connection.getPort()};self.getIsOpen=function(){return connection.getIsOpen()};self.getServiceName=function(){return service_name};self.getType=function(){return isServer?self.PROVIDED:self.REQUIRED};self.getId=function(){return connection.getId()};self.getServer=function(){return isServer?connection:null};self.getConnection=function(){return!isServer?connection:null};self.getIsSecure=function(){return connection.getIsSecure()};self.exposeRpcMethod=function(name,object,method){connection.exposeRpcMethod(name,object,method)};self.callRpc=function(){connection.callRpc.apply(this,arguments)};connection.setConnectionListener(listenConnection);connection.setDisconnectionListener(listenDisconnection);if(isServer){connection.setServerUpListener(listenServerUp);connection.setServerDownListener(listenServerDown)}}if(typeof exports!=="undefined")module.exports=Service;